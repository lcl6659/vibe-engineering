name: Vibe Backend Agent

on:
  issue_comment:
    types: [created]

jobs:
  backend-agent:
    if: contains(github.event.comment.body, '/agent-be')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v5

      - name: Setup Git
        run: |
          git config user.name "vibe-backend-agent"
          git config user.email "agent@vibe.dev"

      - name: Vibe Backend Agent - Generate Backend & API Contract
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          # å›ºå®šæ ‡å‡†é…ç½®
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          script: |
            const fs = require("fs");
            const path = require("path");
            const { execSync } = require("child_process");
            const fetch = require("node-fetch");

            async function runBackendAgent() {
              const { owner, repo } = context.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body;

              // 1. Extract UI Spec comment URL
              const match = commentBody.match(
                /https:\/\/github\.com\/[^\s\)]+\/issues\/\d+#issuecomment-\d+/
              );

              if (!match) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body: [
                    "âŒ **ç¼ºå°‘ UI Spec è¯„è®º URL**",
                    "",
                    "ç”¨æ³•ï¼š",
                    "```",
                    "/agent-be <ui-spec-comment-url>",
                    "```",
                    "",
                    "Backend Agent å¿…é¡»åŸºäºå†»ç»“çš„ UI Spec æ‰§è¡Œã€‚"
                  ].join("\n")
                });
                return;
              }

              const commentUrl = match[0];
              const commentId = commentUrl.split("#issuecomment-")[1];

              // 2. Fetch UI Spec
              const commentRes = await github.rest.issues.getComment({
                owner,
                repo,
                comment_id: Number(commentId)
              });

              const frozenUISpec = commentRes.data.body;

              // 3. Derive API contract
              const contractPrompt = `
                ä½ æ˜¯ä¸€ä¸ªåç«¯ API å¥‘çº¦è®¾è®¡ä¸“å®¶ã€‚
                
                è¯·åŸºäºä»¥ä¸‹å†»ç»“çš„ UI Specï¼Œ
                æ¨å¯¼å‰åç«¯å¯¹é½æ‰€éœ€çš„æœ€å° API å¥‘çº¦ã€‚
                
                UI Spec:
                ${frozenUISpec}
                
                è¿”å› JSONï¼š
                {
                  "endpoint": "/api/parse",
                  "method": "POST",
                  "description": "Parse YouTube/Twitter URL",
                  "request": {
                    "url": "string"
                  },
                  "response": {
                    "source": "youtube | twitter",
                    "title": "string",
                    "author": "string",
                    "summary": "string",
                    "originalUrl": "string"
                  },
                  "errors": [
                    { "code": "INVALID_URL", "message": "Unsupported URL" },
                    { "code": "PARSE_FAILED", "message": "Unable to parse content" }
                  ]
                }
                
                åªè¿”å› JSONã€‚
                `;

              const contractRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: contractPrompt }],
                  temperature: 0.3
                })
              });

              const contractData = await contractRes.json();
              let apiContract;
              try {
                apiContract = JSON.parse(contractData.choices[0].message.content);
              } catch {
                throw new Error("Failed to parse API contract JSON.");
              }

              // 4. Write API contract doc
              const apiDocPath = path.join(process.cwd(), "api/parse.json");
              fs.mkdirSync(path.dirname(apiDocPath), { recursive: true });
              fs.writeFileSync(apiDocPath, JSON.stringify(apiContract, null, 2), "utf8");

              // 5. Post API contract comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "ğŸ“„ **API å¥‘çº¦å·²ç”Ÿæˆï¼ˆå‰åç«¯å¯¹é½ï¼‰**",
                  "",
                  "```json",
                  JSON.stringify(apiContract, null, 2),
                  "```",
                  "",
                  "â³ å¼€å§‹ç”Ÿæˆåç«¯å®ç°ä»£ç ..."
                ].join("\n")
              });

              // 6. Create branch
              const branchName = `agent-be-${issue_number}-${Date.now()}`;
              execSync(`git checkout -b ${branchName}`);

              // 7. Backend implementation prompt
              const systemPrompt = `
                You are the Backend Execution Agent.
                
                RULES:
                - Follow API contract strictly
                - Do not infer UI behavior
                - No persistence unless specified
                - Keep code minimal and explicit
                
                PATH CONSTRAINTS:
                - Implementation files must be under backend/
                - API docs must be under api/
                
                OUTPUT FORMAT:
                {
                  "files": [
                    { "path": "backend/relative/path.go", "content": "full code" }
                  ]
                }
                
                No markdown. No explanation.
                `;
                
                              const userPrompt = `
                API Contract:
                ${JSON.stringify(apiContract, null, 2)}
                `;

              const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "anthropic/claude-3.5-sonnet",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ],
                  temperature: 0.3
                })
              });

              const data = await res.json();
              const raw = data.choices?.[0]?.message?.content;
              if (!raw) throw new Error("Backend model returned empty response.");

              let jsonStr = raw.trim();
              const matchJson = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
              if (matchJson) jsonStr = matchJson[1].trim();

              let parsed;
              try {
                parsed = JSON.parse(jsonStr);
              } catch {
                throw new Error("Backend output is not valid JSON.");
              }

              // 8. Write backend files
              for (const file of parsed.files) {
                if (!file.path.startsWith("backend/")) {
                  throw new Error(`Invalid backend path: ${file.path}`);
                }
                const fullPath = path.join(process.cwd(), file.path);
                fs.mkdirSync(path.dirname(fullPath), { recursive: true });
                fs.writeFileSync(fullPath, file.content, "utf8");
              }

              execSync("git add .");
              execSync(`git commit -m "feat: backend implementation for parsing (#${issue_number})"`);
              execSync(`git push origin ${branchName}`);

              // 9. Create PR
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                title: `Backend: parsing implementation (#${issue_number})`,
                head: branchName,
                base: "main",
                body: [
                  "This PR was generated by Vibe Backend Agent.",
                  "",
                  "Includes:",
                  "- API contract under /api",
                  "- Backend implementation under /backend",
                  "- UI contract respected",
                  "",
                  `UI Spec Source: ${commentUrl}`
                ].join("\n")
              });

              // 10. Final comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: [
                  "âœ… **Backend Agent å®Œæˆ**",
                  "",
                  `ğŸ”— PR: ${pr.data.html_url}`,
                  "",
                  "- API å¥‘çº¦å·²å†™å…¥ /api",
                  "- å®ç°ä»£ç ä½äº /backend",
                  "- UI è§„æ ¼ä¸¥æ ¼éµå®ˆ"
                ].join("\n")
              });
            }

            await runBackendAgent();
