name: Agent Builder (Frontend Strict)

on:
  issue_comment:
    types: [created]

jobs:
  builder:
    # è§¦å‘æŒ‡ä»¤ï¼š/code-zhangxiaohao-agent
    if: contains(github.event.comment.body, '/code-zhangxiaohao-agent')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # âœ¨ æ–°å¢æ­¥éª¤ï¼šè®© Builder ä¹Ÿçœ‹ä¸€çœ¼ç›®å½•ï¼Œé˜²æ­¢è·¯å¾„çå†™
      - name: Generate File Tree
        id: file_tree
        run: |
          # æ’é™¤å¹²æ‰°é¡¹ï¼Œåªçœ‹å…³é”®çš„å‰ç«¯ç›®å½•
          TREE=$(find . -maxdepth 5 -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/dist*' -not -path '*/build*' -not -path '*/.next*' | sed 's|./||' | sort)
          echo "TREE<<EOF" >> $GITHUB_ENV
          echo "$TREE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Execute Frontend Implementation
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          PROJECT_TREE: ${{ env.TREE }} # ä¼ å…¥ç›®å½•ç»“æ„
        with:
          script: |
            // 1. è·å–å†å²è¯„è®º (è¯»å–æ¶æ„å¸ˆçš„å‰ç«¯æ–¹æ¡ˆ)
            console.log("ğŸ“¥ æ­£åœ¨è¯»å–æ¶æ„å¸ˆæ–¹æ¡ˆ...");
            const comments = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            });
            
            const discussionHistory = comments.data
              .map(c => `[User: ${c.user.login}]:\n${c.body}`)
              .join("\n\n--- å†å²åˆ†å‰²çº¿ ---\n\n");

            // 2. è¯»å–çˆ¶çº§è§„èŒƒ
            let contextBody = process.env.ISSUE_BODY;
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = contextBody.match(parentRegex);
            
            if (parentMatch) {
               try {
                 const p = await github.rest.issues.get({ ...context.repo, issue_number: parentMatch[1] });
                 contextBody += `\n\n--- [çˆ¶çº§è§„èŒƒ (ä¸¥æ ¼éµå®ˆ)] ---\n${p.data.body}`;
               } catch(e) {}
            }

            // 3. è¯»å– package.json (è®© AI çŸ¥é“å½“å‰æœ‰å“ªäº›åŒ…)
            let packageJsonContext = "package.json not found";
            try {
               const { data: pkgData } = await github.rest.repos.getContent({
                 ...context.repo,
                 path: 'frontend/package.json' // å‡è®¾å‰ç«¯åœ¨ frontend ç›®å½•ä¸‹ï¼Œå¦‚æœä¸æ˜¯è¯·æŒ‰éœ€è°ƒæ•´
               });
               packageJsonContext = Buffer.from(pkgData.content, 'base64').toString();
            } catch(e) {
               console.log("âš ï¸ æœªæ‰¾åˆ° frontend/package.jsonï¼Œå°è¯•æ ¹ç›®å½•æŸ¥æ‰¾...");
               try {
                 const { data: rootPkg } = await github.rest.repos.getContent({ ...context.repo, path: 'package.json' });
                 packageJsonContext = Buffer.from(rootPkg.content, 'base64').toString();
               } catch(e2) {}
            }

            // 4. æ„å»º Prompt
            const prompt = `ä½ æ˜¯ä¸€å **çº¯ç²¹çš„å‰ç«¯å·¥ç¨‹å¸ˆ (Next.js Expert)**ã€‚
            
            ã€çœŸå®ç¯å¢ƒä¿¡æ¯ (ä¸è¦ççŒœè·¯å¾„)ã€‘
            1. **å½“å‰ç›®å½•ç»“æ„**ï¼š
            ${process.env.PROJECT_TREE}
            
            2. **å½“å‰ package.json**ï¼š
            ${packageJsonContext}

            ã€éœ€æ±‚æ¥æºã€‘
            æ ‡é¢˜ï¼š${process.env.ISSUE_TITLE}
            æè¿°ï¼š${contextBody}

            ã€æ¶æ„å¸ˆæ–¹æ¡ˆã€‘
            ${discussionHistory}

            ã€ä½ çš„ä»»åŠ¡ã€‘
            ç¼–å†™å‰ç«¯ä»£ç æ–‡ä»¶ã€‚

            ã€ğŸ”¥ æ ¸å¿ƒè§„åˆ™ (å¿…é¡»ä¸¥æ ¼æ‰§è¡Œ)ã€‘
            1. **è·¯å¾„ä¸€è‡´æ€§**ï¼šè¯·ä»”ç»†æ¯”å¯¹ã€å½“å‰ç›®å½•ç»“æ„ã€‘ã€‚å¦‚æœç°æœ‰ç»„ä»¶åœ¨ \`frontend/components/ui\`, è¯·ä¸è¦åˆ›å»º \`src/components/ui\`ã€‚å¿…é¡»å¤ç”¨ç°æœ‰ç›®å½•ï¼
            2. **ä¾èµ–ç®¡ç†**ï¼š
               - å¦‚æœä½ ä½¿ç”¨äº†æ–°çš„ npm åŒ…ï¼ˆå¦‚ lodash, dayjs, framer-motionï¼‰ï¼Œ**å¿…é¡»** ä¿®æ”¹ \`package.json\` å¹¶å°†å…¶å®Œæ•´è¾“å‡ºã€‚
               - ä¸è¦åªç»™å®‰è£…å‘½ä»¤ï¼Œç›´æ¥æ›´æ–° package.json æ–‡ä»¶å†…å®¹ã€‚
            3. **çº¯å‰ç«¯**ï¼šåªç”Ÿæˆ .tsx, .ts, .css, .jsonã€‚å¿½ç•¥åç«¯æ–‡ä»¶ã€‚
            4. **æ ¼å¼æ§åˆ¶**ï¼š
               - ä»£ç å†…å®¹ **ä¸è¦** åŒ…å« Markdown çš„ \`\`\`typescript æ ‡è®°ã€‚ç›´æ¥è¾“å‡ºçº¯ä»£ç ã€‚
               - å¦‚æœä½ ä¸ºäº†æ’ç‰ˆåŠ äº† \`\`\`ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨åˆ é™¤ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œï¼Œè¯·çŸ¥æ‚‰ã€‚

            ã€è¾“å‡ºæ ¼å¼ã€‘
            è¯·ä½¿ç”¨ä¸¥æ ¼çš„åˆ†éš”ç¬¦æ ¼å¼ï¼š

            ### FILE: frontend/app/notes/[id]/page.tsx
            (è¿™é‡Œç›´æ¥å†™ import ... ä¸è¦åŠ  \`\`\` ç¬¦å·)
            (ä»£ç å†…å®¹)

            ### FILE: frontend/package.json
            (è¿™é‡Œç›´æ¥å†™å®Œæ•´çš„æ–° json å†…å®¹ï¼Œä¸è¦åŠ  \`\`\`)
            {
              "name": "...",
              "dependencies": { ... }
            }
            `;

            console.log("ğŸ¤– æ­£åœ¨ç¼–å†™å‰ç«¯ä»£ç  (OpenRouter AI)...");

            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-3.5-sonnet",
                messages: [{ role: "user", content: prompt }]
              })
            });
            
            if (!aiRes.ok) throw new Error(`AI API Error: ${await aiRes.text()}`);
            const aiData = await aiRes.json();
            const rawContent = aiData.choices[0].message.content;

            // 5. è§£æåˆ†éš”ç¬¦æ ¼å¼ (ğŸ”¥ å¢å¼ºç‰ˆæ¸…æ´—é€»è¾‘)
            console.log("ğŸ“¦ è§£ææ–‡ä»¶...");
            const files = [];
            const lines = rawContent.split('\n');
            let currentFile = null;
            let currentContentLines = [];

            // è¾…åŠ©å‡½æ•°ï¼šæ¸…æ´—ä»£ç å—æ ‡è®°
            const cleanContent = (linesArray) => {
                let content = linesArray.join('\n').trim();
                // å¦‚æœ AI è¿˜æ˜¯ä¸å¬è¯åŠ äº† ```ï¼Œæˆ‘ä»¬æš´åŠ›å»é™¤
                if (content.startsWith('```')) {
                    content = content.split('\n').slice(1).join('\n'); // å»å¤´
                }
                if (content.endsWith('```')) {
                     // è¿™é‡Œçš„é€»è¾‘è¦å°å¿ƒï¼Œé˜²æ­¢å»æ‰æ­£å¸¸çš„ä»£ç ã€‚é€šå¸¸ AI çš„ ``` æ˜¯ç‹¬å ä¸€è¡Œçš„
                     const tempLines = content.split('\n');
                     if (tempLines[tempLines.length-1].trim().startsWith('```')) {
                         content = tempLines.slice(0, -1).join('\n'); // å»å°¾
                     }
                }
                return content.trim();
            };

            for (const line of lines) {
              if (line.trim().startsWith('### FILE:')) {
                if (currentFile) {
                  files.push({ 
                    path: currentFile, 
                    content: cleanContent(currentContentLines)
                  });
                }
                currentFile = line.replace('### FILE:', '').trim();
                currentContentLines = [];
              } else {
                currentContentLines.push(line);
              }
            }
            if (currentFile) {
              files.push({ 
                path: currentFile, 
                content: cleanContent(currentContentLines)
              });
            }

            if (files.length === 0) {
              console.log("åŸå§‹å†…å®¹:", rawContent);
              throw new Error("AI æœªç”Ÿæˆä»»ä½•æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ Prompt æ ¼å¼æœªè¢«éµå®ˆ");
            }

            // 6. Git æäº¤
            const branchName = `zhangxiaohao/issue-${context.issue.number}`;
            const baseRef = await github.rest.git.getRef({ ...context.repo, ref: 'heads/main' });
            
            try {
                await github.rest.git.createRef({ 
                    ...context.repo, 
                    ref: `refs/heads/${branchName}`, 
                    sha: baseRef.data.object.sha 
                });
            } catch (e) {
                console.log("â„¹ï¸ åˆ†æ”¯å·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°...");
            }

            for (const file of files) {
              // å†æ¬¡è¿‡æ»¤åç«¯æ–‡ä»¶
              if (file.path.endsWith('.go') || file.path.includes('backend/')) {
                  console.log(`âš ï¸ è·³è¿‡åç«¯æ–‡ä»¶: ${file.path}`);
                  continue;
              }

              console.log(`ğŸ“ å†™å…¥æ–‡ä»¶: ${file.path}`);
              
              // è·å– sha ä»¥ä¾¿æ›´æ–°
              let sha;
              try {
                const { data } = await github.rest.repos.getContent({ 
                    ...context.repo, 
                    path: file.path, 
                    ref: branchName 
                });
                sha = data.sha;
              } catch (e) {} 

              await github.rest.repos.createOrUpdateFileContents({
                ...context.repo,
                path: file.path,
                message: `feat(fe): update ${file.path}`,
                content: Buffer.from(file.content).toString('base64'),
                branch: branchName,
                sha: sha
              });
            }

            try {
              const pr = await github.rest.pulls.create({
                ...context.repo,
                title: `âœ¨ [FE] ${process.env.ISSUE_TITLE}`,
                head: branchName,
                base: 'main',
                body: `ğŸ¤– **å‰ç«¯ä»£ç ç”Ÿæˆ**\n\næŒ‡ä»¤: \`/code-zhangxiaohao-agent\`\n\n### ğŸ“¦ äº¤ä»˜æ¸…å•ï¼š\n${files.map(f => `- \`${f.path}\``).join('\n')}\n\næ³¨æ„ï¼šå¦‚æœæœ‰ package.json å˜åŠ¨ï¼Œè¯·åœ¨æœ¬åœ°è¿è¡Œ npm installã€‚`
              });
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âœ… **ä»£ç å·²ç”Ÿæˆï¼**\nPR: ${pr.data.html_url}`
              });
            } catch (e) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âœ… **ä»£ç å·²æ›´æ–°åˆ°åˆ†æ”¯ï¼**`
              });
            }