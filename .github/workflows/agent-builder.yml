name: Agent Builder (Execute Code)

on:
  issue_comment:
    types: [created]

jobs:
  builder:
    # è§¦å‘æŒ‡ä»¤ï¼š/code-zhangxiaohao-agent
    if: contains(github.event.comment.body, '/code-zhangxiaohao-agent')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Execute Implementation
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        with:
          script: |
            // 1. è·å– Issue ä¸‹çš„æ‰€æœ‰è¯„è®º
            console.log("ğŸ“¥ æ­£åœ¨è¯»å–å†å²è¯„è®º(æ¶æ„æ–¹æ¡ˆ)...");
            const comments = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            });
            
            const discussionHistory = comments.data
              .map(c => `[User: ${c.user.login} è¯´]:\n${c.body}`)
              .join("\n\n--- å†å²è®¨è®ºåˆ†å‰²çº¿ ---\n\n");

            // 2. è¯»å–çˆ¶çº§éœ€æ±‚
            let contextBody = process.env.ISSUE_BODY;
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = contextBody.match(parentRegex);
            
            if (parentMatch) {
               const parentId = parentMatch[1];
               console.log(`ğŸ”— åŒ…å«çˆ¶çº§éœ€æ±‚: #${parentId}`);
               try {
                 const p = await github.rest.issues.get({ ...context.repo, issue_number: parentId });
                 contextBody += `\n\n--- [çˆ¶çº§è§„èŒƒ (Issue #${parentId})] ---\n${p.data.body}`;
               } catch(e) { console.log("âš ï¸ è¯»å–çˆ¶çº§å¤±è´¥"); }
            }

            // 3. æ„å»º Prompt (ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šæŠ›å¼ƒ JSONï¼Œæ”¹ç”¨åˆ†éš”ç¬¦æ ¼å¼)
            const prompt = `ä½ æ˜¯ä¸€åé«˜çº§å…¨æ ˆå·¥ç¨‹å¸ˆ (Next.js & Go)ã€‚
            
            ã€éœ€æ±‚æ¥æºã€‘
            æ ‡é¢˜ï¼š${process.env.ISSUE_TITLE}
            æè¿°ï¼š${contextBody}

            ã€æ¶æ„å¸ˆæ–¹æ¡ˆä¸è®¨è®ºã€‘
            ${discussionHistory}

            ã€ä½ çš„ä»»åŠ¡ã€‘
            ç¼–å†™ä»£ç ã€‚ä¸¥æ ¼éµå®ˆæ¶æ„å¸ˆæŒ‡å®šçš„è·¯å¾„ã€‚
            
            ã€è¾“å‡ºæ ¼å¼ - æå…¶é‡è¦ã€‘
            âŒ **ä¸è¦è¿”å› JSONï¼** JSON å¤„ç†é•¿ä»£ç ä¼šå¤±è´¥ã€‚
            âœ… **è¯·ä½¿ç”¨ä»¥ä¸‹åˆ†éš”ç¬¦æ ¼å¼è¿”å›ï¼š**

            ### FILE: frontend/app/page.tsx
            \`\`\`typescript
            (è¿™é‡Œæ˜¯ä»£ç å†…å®¹...)
            \`\`\`

            ### FILE: backend/main.go
            \`\`\`go
            (è¿™é‡Œæ˜¯ä»£ç å†…å®¹...)
            \`\`\`

            ã€çº¦æŸã€‘
            1. å¿…é¡»åŒ…å« import/export å’Œå®Œæ•´é€»è¾‘ã€‚
            2. å¦‚æœæ˜¯ Next.js äº¤äº’ç»„ä»¶ï¼Œç¬¬ä¸€è¡Œå¿…é¡»æ˜¯ "use client";
            `;

            console.log("ğŸ¤– æ­£åœ¨ç¼–å†™ä»£ç  (OpenRouter AI)...");

            // 4. è°ƒç”¨ AI
            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-3.5-sonnet",
                messages: [{ role: "user", content: prompt }]
              })
            });
            
            if (!aiRes.ok) throw new Error(`AI API Error: ${await aiRes.text()}`);
            const aiData = await aiRes.json();
            const rawContent = aiData.choices[0].message.content;

            // 5. è§£æåˆ†éš”ç¬¦æ ¼å¼ (ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šç¨³å¥çš„è§£æé€»è¾‘)
            console.log("ğŸ“¦ è§£æ AI è¿”å›å†…å®¹...");
            const files = [];
            const lines = rawContent.split('\n');
            let currentFile = null;
            let currentContentLines = [];

            for (const line of lines) {
              if (line.trim().startsWith('### FILE:')) {
                // ä¿å­˜ä¸Šä¸€ä¸ªæ–‡ä»¶
                if (currentFile) {
                  files.push({ 
                    path: currentFile, 
                    // å»æ‰é¦–å°¾å¯èƒ½å­˜åœ¨çš„ ``` æ ‡è®°
                    content: currentContentLines.join('\n').replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/, '').trim() 
                  });
                }
                // å¼€å§‹æ–°æ–‡ä»¶
                currentFile = line.replace('### FILE:', '').trim();
                currentContentLines = [];
              } else {
                if (currentFile) {
                  currentContentLines.push(line);
                }
              }
            }
            // ä¿å­˜æœ€åä¸€ä¸ªæ–‡ä»¶
            if (currentFile) {
              files.push({ 
                path: currentFile, 
                content: currentContentLines.join('\n').replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/, '').trim() 
              });
            }

            if (files.length === 0) {
              console.log("åŸå§‹å†…å®¹:", rawContent);
              throw new Error("æœªèƒ½è§£æå‡ºä»»ä½•æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ AI è¿”å›æ ¼å¼");
            }

            console.log(`ğŸ“¦ è§£ææˆåŠŸï¼Œå‡†å¤‡æäº¤ ${files.length} ä¸ªæ–‡ä»¶`);

            // 6. Git æäº¤ä¸ PR
            // æ ¼å¼ç¤ºä¾‹: zhangxiaohao/issue-123
            const branchName = `zhangxiaohao/issue-${context.issue.number}`;
            const baseRef = await github.rest.git.getRef({ ...context.repo, ref: 'heads/main' });
            
            try {
                await github.rest.git.createRef({ 
                    ...context.repo, 
                    ref: `refs/heads/${branchName}`, 
                    sha: baseRef.data.object.sha 
                });
            } catch (e) {
                console.log("â„¹ï¸ åˆ†æ”¯å·²å­˜åœ¨ï¼Œå°†ç›´æ¥æ›´æ–°...");
            }

            for (const file of files) {
              console.log(`ğŸ“ å†™å…¥: ${file.path}`);
              let sha;
              try {
                const { data } = await github.rest.repos.getContent({ 
                    ...context.repo, 
                    path: file.path, 
                    ref: branchName 
                });
                sha = data.sha;
              } catch (e) {} 

              await github.rest.repos.createOrUpdateFileContents({
                ...context.repo,
                path: file.path,
                message: `feat(ai): ${file.path}`,
                content: Buffer.from(file.content).toString('base64'),
                branch: branchName,
                sha: sha
              });
            }

            // åˆ›å»º PR
            try {
              const pr = await github.rest.pulls.create({
                ...context.repo,
                title: `âœ¨ [Impl] ${process.env.ISSUE_TITLE}`,
                head: branchName,
                base: 'main',
                body: `ğŸ¤– **ä»£ç ç”Ÿæˆå®Œæ¯•**\n\næŒ‡ä»¤: \`/code-zhangxiaohao-agent\`\n\n### ä¿®æ”¹æ–‡ä»¶ï¼š\n${files.map(f => `- \`${f.path}\``).join('\n')}`
              });
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âœ… **ä»£ç å·²ç”Ÿæˆï¼**\nPR: ${pr.data.html_url}`
              });
            } catch (e) {
              // å¦‚æœ PR å·²å­˜åœ¨ï¼Œåªå›å¤
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.issue.number,
                body: `âœ… **ä»£ç å·²æ›´æ–°åˆ°ç°æœ‰åˆ†æ”¯ï¼**\nè¯·æŸ¥çœ‹ä»£ç å˜åŠ¨ã€‚`
              });
            }