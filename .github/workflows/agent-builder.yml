name: Agent Builder (Execute Code)

on:
  issue_comment:
    types: [created]

jobs:
  builder:
    # è§¦å‘æŒ‡ä»¤ï¼š/code-zhangxiaohao-agent
    if: contains(github.event.comment.body, '/code-zhangxiaohao-agent')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Execute Implementation
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        with:
          script: |
            // 1. è·å– Issue ä¸‹çš„æ‰€æœ‰è¯„è®ºï¼ˆä¸ºäº†æ‰¾åˆ°æ¶æ„å¸ˆçš„æ–¹æ¡ˆï¼‰
            console.log("ğŸ“¥ æ­£åœ¨è¯»å–å†å²è¯„è®º(æ¶æ„æ–¹æ¡ˆ)...");
            const comments = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.issue.number
            });
            
            // æ‰¾åˆ°æ‰€æœ‰è¯„è®ºçš„æ–‡æœ¬ï¼Œæ‹¼æ¥ç»™ AI åšä¸Šä¸‹æ–‡
            const discussionHistory = comments.data
              .map(c => `[User: ${c.user.login} è¯´]:\n${c.body}`)
              .join("\n\n--- å†å²è®¨è®ºåˆ†å‰²çº¿ ---\n\n");

            // 2. å°è¯•è¯»å–çˆ¶çº§éœ€æ±‚
            let contextBody = process.env.ISSUE_BODY;
            const parentRegex = /(?:Parent|Ref|çˆ¶ä»»åŠ¡|çˆ¶çº§|çˆ¶éœ€æ±‚|å…³è”çˆ¶éœ€æ±‚)[\s:ï¼š]+#(\d+)/i;
            const parentMatch = contextBody.match(parentRegex);
            
            if (parentMatch) {
               const parentId = parentMatch[1];
               console.log(`ğŸ”— åŒ…å«çˆ¶çº§éœ€æ±‚: #${parentId}`);
               try {
                 const p = await github.rest.issues.get({ ...context.repo, issue_number: parentId });
                 contextBody += `\n\n--- [çˆ¶çº§è§„èŒƒ (Issue #${parentId})] ---\n${p.data.body}`;
               } catch(e) {
                 console.log(`âš ï¸ è¯»å–çˆ¶çº§å¤±è´¥: ${e.message}`);
               }
            }

            // 3. æ„å»º Prompt
            const prompt = `ä½ æ˜¯ä¸€åé«˜çº§å…¨æ ˆå·¥ç¨‹å¸ˆ (Next.js & Go)ã€‚
            
            ã€éœ€æ±‚æ¥æºã€‘
            æ ‡é¢˜ï¼š${process.env.ISSUE_TITLE}
            åŸå§‹æè¿°ï¼š${contextBody}

            ã€æ¶æ„å¸ˆè§„åˆ’ä¸è®¨è®ºå†å²ã€‘
            **è¯·é‡ç‚¹é˜…è¯»ä¸‹æ–¹çš„ "å®æ–½æ–¹æ¡ˆ"ï¼Œä¸¥æ ¼æŒ‰ç…§æ¶æ„å¸ˆæŒ‡å®šçš„è·¯å¾„ç”Ÿæˆä»£ç ï¼š**
            ${discussionHistory}

            ã€ä½ çš„ä»»åŠ¡ã€‘
            ç¼–å†™å…·ä½“çš„ä»£ç å®ç°æ–‡ä»¶ã€‚
            
            ã€ä¸¥æ ¼çº¦æŸã€‘
            1. **è·¯å¾„æœä»**ï¼šä¸¥æ ¼æŒ‰ç…§æ¶æ„å¸ˆæ–¹æ¡ˆé‡Œçš„è·¯å¾„ã€‚å¦‚æœæ¶æ„å¸ˆè¯´ "æ”¾åœ¨ components/ui"ï¼Œä½ å°±ä¸èƒ½æ”¾åœ¨ "components/common"ã€‚
            2. **ä»£ç å®Œæ•´**ï¼šè¾“å‡ºå®Œæ•´çš„ä»£ç æ–‡ä»¶ï¼ˆåŒ…å« import, export, "use client" ç­‰ï¼‰ï¼Œä¸è¦ä½¿ç”¨çœç•¥å·ã€‚
            3. **æ ¼å¼**ï¼šä½ å¿…é¡»åªè¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚
            4. **æŠ€æœ¯æ ˆ**ï¼šNext.js App Router, Tailwind CSS, TypeScriptã€‚
            
            ã€è¾“å‡º JSON æ ¼å¼ã€‘
            {
              "files": [
                {
                  "path": "frontend/app/page.tsx",
                  "content": "\"use client\";\nimport..."
                }
              ]
            }`;

            console.log("ğŸ¤– æ­£åœ¨ç¼–å†™ä»£ç  (OpenRouter AI)...");

            // 4. è°ƒç”¨ AI ç”Ÿæˆä»£ç 
            const aiRes = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-3.5-sonnet",
                messages: [{ role: "user", content: prompt }],
                response_format: { type: "json_object" }
              })
            });
            
            if (!aiRes.ok) {
                const err = await aiRes.text();
                throw new Error(`AI API Error: ${err}`);
            }

            const aiData = await aiRes.json();
            
            // æ¸…æ´— Markdown æ ‡è®° (é˜²æ­¢ AI è™½ç„¶è¢«è¦æ±‚ JSON ä½†è¿˜æ˜¯åŠ äº† ```json)
            let contentStr = aiData.choices[0].message.content.replace(/^```json\s*/, '').replace(/\s*```$/, '');
            
            let files;
            try {
                files = JSON.parse(contentStr).files;
                if (!files || files.length === 0) throw new Error("No files returned from AI");
            } catch (e) {
                console.error("AI è¿”å›å†…å®¹:", contentStr);
                throw new Error("JSON è§£æå¤±è´¥ï¼ŒAI å¯èƒ½æ²¡è¿”å›æ­£ç¡®çš„ JSON æ ¼å¼");
            }

            console.log(`ğŸ“¦ ç”Ÿæˆäº† ${files.length} ä¸ªæ–‡ä»¶ï¼Œå‡†å¤‡æäº¤...`);

            // 5. Git æäº¤ä¸ PR æµç¨‹
            const branchName = `zhangxiaohao/feature-${context.issue.number}-${Date.now()}`;
            
            // è·å– main åˆ†æ”¯æœ€æ–° SHA (å¦‚æœä½ çš„ä¸»åˆ†æ”¯å« masterï¼Œè¯·æŠŠä¸‹é¢çš„ 'main' æ”¹ä¸º 'master')
            const baseRef = await github.rest.git.getRef({ ...context.repo, ref: 'heads/main' });
            
            // åˆ›å»ºæ–°åˆ†æ”¯
            await github.rest.git.createRef({ 
                ...context.repo, 
                ref: `refs/heads/${branchName}`, 
                sha: baseRef.data.object.sha 
            });

            // å¾ªç¯å†™å…¥æ–‡ä»¶
            for (const file of files) {
              console.log(`ğŸ“ å†™å…¥: ${file.path}`);
              let sha;
              try {
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆç”¨äºæ›´æ–°ï¼‰
                const { data } = await github.rest.repos.getContent({ 
                    ...context.repo, 
                    path: file.path, 
                    ref: branchName 
                });
                sha = data.sha;
              } catch (e) {} // æ–‡ä»¶ä¸å­˜åœ¨åˆ™ sha ä¸º undefined

              await github.rest.repos.createOrUpdateFileContents({
                ...context.repo,
                path: file.path,
                message: `feat(ai): ${file.path}`,
                content: Buffer.from(file.content).toString('base64'),
                branch: branchName,
                sha: sha
              });
            }

            // åˆ›å»º PR
            const pr = await github.rest.pulls.create({
              ...context.repo,
              title: `âœ¨ [AI Impl] ${process.env.ISSUE_TITLE}`,
              head: branchName,
              base: 'main',
              body: `ğŸ¤– **Code Generated by Agent Builder**\n\næŒ‡ä»¤: \`/code-zhangxiaohao-agent\`\nåŸºäºæ¶æ„å¸ˆæ–¹æ¡ˆè‡ªåŠ¨ç”Ÿæˆã€‚\n\n### åŒ…å«æ–‡ä»¶ï¼š\n${files.map(f => `- \`${f.path}\``).join('\n')}`
            });
            
            // å›å¤ Issue
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `âœ… **ä»£ç ç”Ÿæˆå®Œæ¯•ï¼**\nè¯·æŸ¥çœ‹ PR è¿›è¡Œä»£ç å®¡æŸ¥: ${pr.data.html_url}`
            });