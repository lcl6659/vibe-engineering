name: Complex Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue ç¼–å·'
        required: true
        type: string
      continuation_context:
        description: 'ç»§ç»­è¿­ä»£çš„ä¸Šä¸‹æ–‡ä¿¡æ¯'
        required: false
        type: string
  issue_comment:
    types: [created]

jobs:
  complex-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-complex å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/agent-complex')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            return { issueNumber, title: issue.title, body: issue.body };

      - name: Update Issue Status
        id: update_issue_status
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            // æ›´æ–°æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'complexity:complex'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ğŸ¤– ai-processing', 'agent:complex', 'epic']
            });

            // åˆ›å»ºè¿›åº¦è¿½è¸ªè¯„è®º
            const progressComment = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                "",
                "---",
                "",
                "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                "",
                "**å½“å‰é˜¶æ®µ**: ğŸ”„ å‡†å¤‡ä¸­...",
                "",
                "```",
                "â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0%",
                "```",
                "",
                "**çŠ¶æ€**: â³ æ­£åœ¨åˆå§‹åŒ–...",
                "",
                "**æ‰§è¡Œè®¡åˆ’:**",
                "1. åˆ†æéœ€æ±‚å¹¶è¯†åˆ«æ¨¡å—",
                "2. æ‹†åˆ†ä¸ºå¯ç‹¬ç«‹å¼€å‘çš„å­ä»»åŠ¡",
                "3. åˆ›å»ºå­ Issue å¹¶è®¾ç½®ä¾èµ–å…³ç³»",
                "4. æŒ‰ä¾èµ–é¡ºåºè‡ªåŠ¨è§¦å‘å¼€å‘",
                "",
                "---",
                "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
              ].join("\n")
            });
            
            // ä¿å­˜è¯„è®º ID ä¾›åç»­æ›´æ–°
            core.setOutput('progress_comment_id', progressComment.data.id);

      - name: Update Progress - Loading Template
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            
            if (progressCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: [
                  "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                  "",
                  "---",
                  "",
                  "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                  "",
                  "**å½“å‰é˜¶æ®µ**: ğŸ“ åŠ è½½æ¨¡æ¿å’Œå‡†å¤‡æç¤ºè¯...",
                  "",
                  "```",
                  "â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10%",
                  "```",
                  "",
                  "**çŠ¶æ€**: â³ æ­£åœ¨åŠ è½½æ‹†åˆ†æ¨¡æ¿...",
                  "",
                  "**æ‰§è¡Œè®¡åˆ’:**",
                  "1. âœ… åˆ†æéœ€æ±‚å¹¶è¯†åˆ«æ¨¡å—",
                  "2. â³ æ‹†åˆ†ä¸ºå¯ç‹¬ç«‹å¼€å‘çš„å­ä»»åŠ¡",
                  "3. â³ åˆ›å»ºå­ Issue å¹¶è®¾ç½®ä¾èµ–å…³ç³»",
                  "4. â³ æŒ‰ä¾èµ–é¡ºåºè‡ªåŠ¨è§¦å‘å¼€å‘",
                  "",
                  "---",
                  "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
                ].join("\n")
              });
            }

      - name: Load Prompt Template
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/complex.md
          variables: |
            {
              "title": ${{ toJson(steps.issue_info.outputs.issue_title) }},
              "body": ${{ toJson(steps.issue_info.outputs.issue_body) }}
            }

      - name: Update Progress - Analyzing
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const progressCommentId = ${{ steps.update_issue_status.outputs.progress_comment_id }};
            
            if (progressCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: progressCommentId,
                body: [
                  "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                  "",
                  "---",
                  "",
                  "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                  "",
                  "**å½“å‰é˜¶æ®µ**: ğŸ¤– AI æ­£åœ¨åˆ†æéœ€æ±‚...",
                  "",
                  "```",
                  "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30%",
                  "```",
                  "",
                  "**çŠ¶æ€**: â³ Claude æ­£åœ¨åˆ†æä»»åŠ¡ç»“æ„...",
                  "",
                  "**æ‰§è¡Œè®¡åˆ’:**",
                  "1. â³ åˆ†æéœ€æ±‚å¹¶è¯†åˆ«æ¨¡å—",
                  "2. â³ æ‹†åˆ†ä¸ºå¯ç‹¬ç«‹å¼€å‘çš„å­ä»»åŠ¡",
                  "3. â³ åˆ›å»ºå­ Issue å¹¶è®¾ç½®ä¾èµ–å…³ç³»",
                  "4. â³ æŒ‰ä¾èµ–é¡ºåºè‡ªåŠ¨è§¦å‘å¼€å‘",
                  "",
                  "**æç¤º**: è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…",
                  "",
                  "---",
                  "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
                ].join("\n")
              });
            }

      - name: Analyze and Create Sub-Issues
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PROMPT_CONTENT: ${{ steps.prompt.outputs.prompt }}
          PROGRESS_COMMENT_ID: ${{ steps.update_issue_status.outputs.progress_comment_id }}
          ISSUE_NUMBER: ${{ steps.issue_info.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue_info.outputs.issue_title }}
          ISSUE_BODY: ${{ steps.issue_info.outputs.issue_body }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const title = process.env.ISSUE_TITLE || '';
            const body = process.env.ISSUE_BODY || '';

            console.log("=".repeat(60));
            console.log("ğŸ“‹ COMPLEX AGENT - ä»»åŠ¡æ‹†åˆ†");
            console.log("=".repeat(60));

            // ä½¿ç”¨ä»æ¨¡æ¿åŠ è½½çš„ prompt
            const prompt = process.env.PROMPT_CONTENT;
            console.log("ğŸ“„ ä½¿ç”¨æ¨¡æ¿: agents/complex.md");

            try {
              const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "anthropic/claude-sonnet-4",
                  messages: [{ role: "user", content: prompt }],
                  temperature: 0.2
                })
              });

              if (!response.ok) {
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
              }

              const data = await response.json();
              let result = data.choices?.[0]?.message?.content || '';

              // æå– JSON
              const jsonMatch = result.match(/\{[\s\S]*\}/);
              if (!jsonMatch) {
                throw new Error("æ— æ³•è§£æ AI å“åº”");
              }

              const parsed = JSON.parse(jsonMatch[0]);
              const tasks = parsed.tasks || [];
              const architectureNotes = parsed.architecture_notes || '';

              console.log(`âœ… è¯†åˆ«åˆ° ${tasks.length} ä¸ªå­ä»»åŠ¡`);

              // æ›´æ–°è¿›åº¦ï¼šåˆ†æå®Œæˆï¼Œå¼€å§‹åˆ›å»ºå­ Issue
              const progressCommentId = process.env.PROGRESS_COMMENT_ID;
              if (progressCommentId && progressCommentId !== '') {
                try {
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: parseInt(progressCommentId),
                    body: [
                      "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                      "",
                      "---",
                      "",
                      "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                      "",
                      "**å½“å‰é˜¶æ®µ**: ğŸ“ æ­£åœ¨åˆ›å»ºå­ Issue...",
                      "",
                      "```",
                      "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 50%",
                      "```",
                      "",
                      `**çŠ¶æ€**: â³ å·²è¯†åˆ« ${tasks.length} ä¸ªå­ä»»åŠ¡ï¼Œæ­£åœ¨åˆ›å»º...`,
                      "",
                      "**æ‰§è¡Œè®¡åˆ’:**",
                      "1. âœ… åˆ†æéœ€æ±‚å¹¶è¯†åˆ«æ¨¡å—",
                      "2. âœ… æ‹†åˆ†ä¸ºå¯ç‹¬ç«‹å¼€å‘çš„å­ä»»åŠ¡",
                      "3. â³ åˆ›å»ºå­ Issue å¹¶è®¾ç½®ä¾èµ–å…³ç³»",
                      "4. â³ æŒ‰ä¾èµ–é¡ºåºè‡ªåŠ¨è§¦å‘å¼€å‘",
                      "",
                      "---",
                      "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
                    ].join("\n")
                  });
                } catch (e) {
                  console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
                }
              }

              if (tasks.length === 0) {
                throw new Error("æœªèƒ½æ‹†åˆ†å‡ºå­ä»»åŠ¡");
              }

              // åˆ›å»ºå­ Issues
              const createdIssues = [];
              const typeLabels = {
                'database': ['database', 'backend'],
                'backend': ['backend'],
                'frontend': ['frontend'],
                'fullstack': ['frontend', 'backend']
              };

              const typeAgents = {
                'database': 'agent-medium',
                'backend': 'agent-medium',
                'frontend': 'agent-medium',
                'fullstack': 'agent-medium'
              };

              for (let i = 0; i < tasks.length; i++) {
                const task = tasks[i];

                // æ„å»ºä¾èµ–è¯´æ˜
                let dependsText = '';
                if (task.depends_on && task.depends_on.length > 0) {
                  const depTitles = task.depends_on.map(idx => {
                    if (createdIssues[idx]) {
                      return `#${createdIssues[idx].number}`;
                    }
                    return `ä»»åŠ¡ ${idx + 1}`;
                  });
                  dependsText = `\n\n**å‰ç½®ä¾èµ–:** ${depTitles.join(', ')}`;
                }

                // éªŒæ”¶æ ‡å‡†
                const criteriaText = task.acceptance_criteria?.length > 0
                  ? `\n\n**éªŒæ”¶æ ‡å‡†:**\n${task.acceptance_criteria.map(c => `- [ ] ${c}`).join('\n')}`
                  : '';

                const subIssueBody = [
                  `## ğŸ”— å…³è”`,
                  ``,
                  `Parent: #${issueNumber}`,
                  `ä»»åŠ¡åºå·: ${i + 1}/${tasks.length}`,
                  dependsText,
                  ``,
                  `---`,
                  ``,
                  `## ğŸ“‹ ä»»åŠ¡æè¿°`,
                  ``,
                  task.description,
                  criteriaText,
                  ``,
                  `---`,
                  ``,
                  `## ğŸ“Š ä»»åŠ¡ä¿¡æ¯`,
                  ``,
                  `- **ç±»å‹:** ${task.type}`,
                  `- **ä¼˜å…ˆçº§:** P${task.priority}`,
                  `- **é¢„ä¼°å·¥æ—¶:** ${task.estimated_hours} å°æ—¶`,
                  ``,
                  `---`,
                  ``,
                  `> ğŸ¤– æ­¤ Issue ç”± Complex Agent è‡ªåŠ¨åˆ›å»º`,
                  `> å®Œæˆå‰ç½®ä¾èµ–åï¼Œä½¿ç”¨ \`/agent-medium\` æˆ– \`/agent-simple\` è§¦å‘å¼€å‘`
                ].filter(Boolean).join('\n');

                const labels = [
                  'sub-issue',
                  `priority:P${task.priority}`,
                  ...(typeLabels[task.type] || [])
                ];

                // æ ¹æ®é¢„ä¼°å·¥æ—¶å†³å®šå¤æ‚åº¦æ ‡ç­¾
                if (task.estimated_hours <= 2) {
                  labels.push('complexity:simple');
                } else if (task.estimated_hours <= 6) {
                  labels.push('complexity:medium');
                } else {
                  labels.push('complexity:complex');
                }

                const { data: subIssue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[${task.type.toUpperCase()}] ${task.title}`,
                  body: subIssueBody,
                  labels: labels
                });

                createdIssues.push({
                  number: subIssue.number,
                  title: task.title,
                  type: task.type,
                  priority: task.priority,
                  estimated_hours: task.estimated_hours || 4,
                  depends_on: task.depends_on || []
                });

                console.log(`âœ… åˆ›å»ºå­ Issue #${subIssue.number}: ${task.title}`);
                
                // æ›´æ–°è¿›åº¦ï¼šæ˜¾ç¤ºåˆ›å»ºè¿›åº¦
                const progressCommentId = process.env.PROGRESS_COMMENT_ID;
                if (progressCommentId && progressCommentId !== '') {
                  try {
                    const progress = Math.round(50 + (i + 1) / tasks.length * 40);
                    await github.rest.issues.updateComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: parseInt(progressCommentId),
                      body: [
                        "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                        "",
                        "---",
                        "",
                        "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                        "",
                        "**å½“å‰é˜¶æ®µ**: ğŸ“ æ­£åœ¨åˆ›å»ºå­ Issue...",
                        "",
                        "```",
                        `${'â–ˆ'.repeat(Math.floor(progress / 5))}${'â–‘'.repeat(20 - Math.floor(progress / 5))} ${progress}%`,
                        "```",
                        "",
                        `**çŠ¶æ€**: â³ å·²åˆ›å»º ${i + 1}/${tasks.length} ä¸ªå­ Issue...`,
                        "",
                        "**æ‰§è¡Œè®¡åˆ’:**",
                        "1. âœ… åˆ†æéœ€æ±‚å¹¶è¯†åˆ«æ¨¡å—",
                        "2. âœ… æ‹†åˆ†ä¸ºå¯ç‹¬ç«‹å¼€å‘çš„å­ä»»åŠ¡",
                        "3. â³ åˆ›å»ºå­ Issue å¹¶è®¾ç½®ä¾èµ–å…³ç³»",
                        "4. â³ æŒ‰ä¾èµ–é¡ºåºè‡ªåŠ¨è§¦å‘å¼€å‘",
                        "",
                        "---",
                        "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
                      ].join("\n")
                    });
                  } catch (e) {
                    // å¿½ç•¥æ›´æ–°é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
                  }
                }
              }

              // æ›´æ–°è¿›åº¦ï¼šåˆ›å»ºå®Œæˆ
              const finalProgressCommentId = process.env.PROGRESS_COMMENT_ID;
              if (finalProgressCommentId && finalProgressCommentId !== '') {
                try {
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: parseInt(finalProgressCommentId),
                    body: [
                      "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                      "",
                      "---",
                      "",
                      "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                      "",
                      "**å½“å‰é˜¶æ®µ**: âœ… å®Œæˆ",
                      "",
                      "```",
                      "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%",
                      "```",
                      "",
                      `**çŠ¶æ€**: âœ… å·²åˆ›å»º ${createdIssues.length} ä¸ªå­ Issue`,
                      "",
                      "**æ‰§è¡Œè®¡åˆ’:**",
                      "1. âœ… åˆ†æéœ€æ±‚å¹¶è¯†åˆ«æ¨¡å—",
                      "2. âœ… æ‹†åˆ†ä¸ºå¯ç‹¬ç«‹å¼€å‘çš„å­ä»»åŠ¡",
                      "3. âœ… åˆ›å»ºå­ Issue å¹¶è®¾ç½®ä¾èµ–å…³ç³»",
                      "4. âœ… æŒ‰ä¾èµ–é¡ºåºè‡ªåŠ¨è§¦å‘å¼€å‘",
                      "",
                      "---",
                      "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
                    ].join("\n")
                  });
                } catch (e) {
                  console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
                }
              }

              // åœ¨çˆ¶ Issue å‘å¸ƒæ±‡æ€»è¯„è®º
              const summaryTable = createdIssues.map((iss, idx) => {
                const deps = iss.depends_on.length > 0
                  ? iss.depends_on.map(d => `#${createdIssues[d]?.number || '?'}`).join(', ')
                  : '-';
                return `| ${idx + 1} | #${iss.number} | ${iss.title} | ${iss.type} | P${iss.priority} | ${deps} |`;
              }).join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  "âœ… **ä»»åŠ¡æ‹†åˆ†å®Œæˆ**",
                  "",
                  `å…±åˆ›å»º **${createdIssues.length}** ä¸ªå­ Issueï¼š`,
                  "",
                  "| # | Issue | æ ‡é¢˜ | ç±»å‹ | ä¼˜å…ˆçº§ | ä¾èµ– |",
                  "|---|-------|------|------|--------|------|",
                  summaryTable,
                  "",
                  architectureNotes ? `**æ¶æ„è¯´æ˜:**\n${architectureNotes}\n` : '',
                  "---",
                  "",
                  "**ä¸‹ä¸€æ­¥æ“ä½œ:**",
                  "1. æ£€æŸ¥å­ Issue çš„æ‹†åˆ†æ˜¯å¦åˆç†",
                  "2. ä»æ²¡æœ‰ä¾èµ–çš„ Issue å¼€å§‹ï¼ˆä¼˜å…ˆçº§é«˜çš„å…ˆåšï¼‰",
                  "3. åœ¨å­ Issue ä¸­ä½¿ç”¨ `/agent-medium` æˆ– `/agent-simple` è§¦å‘å¼€å‘",
                  "",
                  "> ğŸ’¡ å»ºè®®æŒ‰ç…§ æ•°æ®åº“ â†’ åç«¯ â†’ å‰ç«¯ çš„é¡ºåºå¼€å‘",
                  "",
                  "---",
                  "> ğŸ¤– ç”± Vibe Complex Agent è‡ªåŠ¨å¤„ç†"
                ].filter(Boolean).join("\n")
              });

              // æ›´æ–°æ ‡ç­¾
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'ğŸ¤– ai-processing'
                });
              } catch (e) {}

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âœ… ai-completed', 'has-subtasks']
              });

              // è‡ªåŠ¨è§¦å‘ç¬¬ä¸€ä¸ªæ— ä¾èµ–çš„å­ä»»åŠ¡
              const firstTask = createdIssues.find(iss => !iss.depends_on || iss.depends_on.length === 0);
              if (firstTask) {
                // æ ¹æ®é¢„ä¼°å·¥æ—¶é€‰æ‹© agent ç±»å‹
                const agentWorkflow = firstTask.estimated_hours <= 2 ? 'agent-simple.yml' : 'agent-medium.yml';
                const agentType = firstTask.estimated_hours <= 2 ? 'Simple' : 'Medium';

                try {
                  // ä½¿ç”¨ workflow_dispatch ç›´æ¥è§¦å‘ï¼Œè€Œä¸æ˜¯å‘è¯„è®ºï¼ˆbot è¯„è®ºä¸ä¼šè§¦å‘ workflowï¼‰
                  await github.rest.actions.createWorkflowDispatch({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    workflow_id: agentWorkflow,
                    ref: 'main',
                    inputs: {
                      issue_number: String(firstTask.number)
                    }
                  });

                  // å‘è¯„è®ºé€šçŸ¥
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: firstTask.number,
                    body: `ğŸ¤– **${agentType} Agent å·²è‡ªåŠ¨è§¦å‘**\n\næ­¤ä»»åŠ¡æ— å‰ç½®ä¾èµ–ï¼Œå·²é€šè¿‡ workflow_dispatch è‡ªåŠ¨å¯åŠ¨å¼€å‘ã€‚\n\n> ğŸ“Š å¯é€šè¿‡ [Actions](/${context.repo.owner}/${context.repo.repo}/actions) æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€`
                  });

                  console.log(`ğŸš€ é€šè¿‡ workflow_dispatch è§¦å‘å­ä»»åŠ¡ #${firstTask.number} (${agentWorkflow})`);
                } catch (dispatchError) {
                  console.error(`âŒ è§¦å‘å­ä»»åŠ¡å¤±è´¥: ${dispatchError.message}`);
                  // å‘è¯„è®ºæç¤ºæ‰‹åŠ¨è§¦å‘
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: firstTask.number,
                    body: `âš ï¸ **è‡ªåŠ¨è§¦å‘å¤±è´¥**\n\næ— æ³•è‡ªåŠ¨å¯åŠ¨ Agent: ${dispatchError.message}\n\nè¯·æ‰‹åŠ¨ä½¿ç”¨ \`/agent-medium\` æˆ– \`/agent-simple\` å‘½ä»¤è§¦å‘ã€‚`
                  });
                }
              }

            } catch (error) {
              console.error("âŒ ä»»åŠ¡æ‹†åˆ†å¤±è´¥:", error.message);

              // æ›´æ–°è¿›åº¦è¯„è®ºä¸ºå¤±è´¥çŠ¶æ€
              const progressCommentId = process.env.PROGRESS_COMMENT_ID;
              if (progressCommentId) {
                try {
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: parseInt(progressCommentId),
                    body: [
                      "ğŸ“‹ **Complex Agent å¯åŠ¨**",
                      "",
                      "---",
                      "",
                      "## ğŸ“Š æ‰§è¡Œè¿›åº¦",
                      "",
                      "**å½“å‰é˜¶æ®µ**: âŒ å¤±è´¥",
                      "",
                      "```",
                      "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30%",
                      "```",
                      "",
                      "**çŠ¶æ€**: âŒ æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯",
                      "",
                      "---",
                      "> ğŸ’¡ å¤æ‚ä»»åŠ¡éœ€è¦æ‹†åˆ†åæ‰èƒ½é«˜æ•ˆå¤„ç†ã€‚"
                    ].join("\n")
                  });
                } catch (e) {
                  console.log("æ— æ³•æ›´æ–°è¿›åº¦è¯„è®º:", e.message);
                }
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  "âŒ **Complex Agent å¤±è´¥**",
                  "",
                  `é”™è¯¯: ${error.message}`,
                  "",
                  "**å¯èƒ½çš„åŸå› :**",
                  "- éœ€æ±‚æè¿°ä¸å¤Ÿè¯¦ç»†",
                  "- éœ€æ±‚èŒƒå›´è¿‡å¤§æˆ–è¿‡å°",
                  "- API è°ƒç”¨å¤±è´¥",
                  "",
                  "**è§£å†³æ–¹æ¡ˆ:**",
                  "- è¡¥å……éœ€æ±‚æè¿°ï¼ˆåŒ…å«å…·ä½“åŠŸèƒ½ç‚¹ï¼‰",
                  "- ä½¿ç”¨ `/agent-complex` é‡è¯•",
                  "- æˆ–æ‰‹åŠ¨æ‹†åˆ†éœ€æ±‚åä½¿ç”¨ `/agent-medium`",
                  "",
                  "---",
                  "> ğŸ¤– ç”± Vibe Complex Agent å¤„ç†"
                ].join("\n")
              });

              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: 'ğŸ¤– ai-processing'
                });
              } catch (e) {}

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âŒ ai-failed', 'needs-review']
              });

              core.setFailed(error.message);
            }
