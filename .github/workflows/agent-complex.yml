name: Complex Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue ç¼–å·'
        required: true
        type: string
  issue_comment:
    types: [created]

jobs:
  complex-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-complex å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/agent-complex')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            return { issueNumber, title: issue.title, body: issue.body };

      - name: Route and Trigger Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const title = ${{ toJson(steps.issue_info.outputs.issue_title) }};
            const body = ${{ toJson(steps.issue_info.outputs.issue_body) }};

            console.log("=".repeat(60));
            console.log("ğŸ“‹ COMPLEX AGENT - è·¯ç”±åˆ°å¯¹åº” Agent");
            console.log("=".repeat(60));
            console.log(`Issue #${issueNumber}: ${title}`);

            // è§£æä»»åŠ¡ç±»å‹ï¼ˆç”¨äºæ—¥å¿—å’Œæ ‡ç­¾ï¼‰
            const typeMatch = body.match(/ç±»å‹[ï¼š:]\s*(.+)/i);
            const typeText = typeMatch ? typeMatch[1].toLowerCase() : '';
            const titleUpper = title.toUpperCase();

            let taskType = 'unknown';
            if (typeText.includes('å…¨æ ˆ') || titleUpper.includes('[BE+FE]') || titleUpper.includes('[FE+BE]')) {
              taskType = 'fullstack';
              console.log("ğŸ“Œ æ£€æµ‹åˆ°å…¨æ ˆä»»åŠ¡ [BE+FE]");
            } else if (typeText.includes('åç«¯') || titleUpper.includes('[BE]')) {
              taskType = 'backend';
              console.log("ğŸ“Œ æ£€æµ‹åˆ°åç«¯ä»»åŠ¡ [BE]");
            } else if (typeText.includes('å‰ç«¯') || titleUpper.includes('[FE]')) {
              taskType = 'frontend';
              console.log("ğŸ“Œ æ£€æµ‹åˆ°å‰ç«¯ä»»åŠ¡ [FE]");
            } else {
              console.log("ğŸ“Œ æœªè¯†åˆ«å…·ä½“ç±»å‹ï¼ŒæŒ‰é€šç”¨ä»»åŠ¡å¤„ç†");
            }

            // æ‰€æœ‰ä»»åŠ¡ç»Ÿä¸€ä½¿ç”¨ agent-medium æ‰§è¡Œ
            const agentWorkflow = 'agent-medium.yml';
            console.log(`ğŸ“Œ è§¦å‘ ${agentWorkflow} å¼€å§‹æ‰§è¡Œä»»åŠ¡`);

            // å‘å¸ƒè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "ğŸ“‹ **Complex Agent - å¼€å§‹æ‰§è¡Œ**",
                "",
                `ä»»åŠ¡ç±»å‹: **${taskType}**`,
                "",
                `æ­£åœ¨è§¦å‘ \`${agentWorkflow}\` å¼€å§‹å†™ä»£ç ...`,
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Complex Agent å¤„ç†"
              ].join("\n")
            });

            // æ·»åŠ æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'complexity:complex'
              });
            } catch (e) {}

            const labels = ['ğŸ¤– ai-processing'];
            if (taskType !== 'unknown') labels.push(taskType);

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: labels
            });

            // è§¦å‘å¯¹åº” Agent
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: agentWorkflow,
                ref: 'main',
                inputs: {
                  issue_number: String(issueNumber)
                }
              });

              console.log(`ğŸš€ å·²è§¦å‘ ${agentWorkflow} for Issue #${issueNumber}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âœ… **Agent å·²è§¦å‘ï¼Œå¼€å§‹å†™ä»£ç **\n\nä»»åŠ¡ç±»å‹: ${taskType}\n\n> ğŸ“Š å¯é€šè¿‡ [Actions](/${context.repo.owner}/${context.repo.repo}/actions) æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€`
              });

            } catch (err) {
              console.error(`âŒ è§¦å‘ ${agentWorkflow} å¤±è´¥: ${err.message}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  "âŒ **è§¦å‘ Agent å¤±è´¥**",
                  "",
                  `é”™è¯¯: ${err.message}`,
                  "",
                  `è¯·æ‰‹åŠ¨ä½¿ç”¨ \`/agent-be\` æˆ– \`/agent-fe\` å‘½ä»¤è§¦å‘ã€‚`,
                  "",
                  "---",
                  "> ğŸ¤– ç”± Vibe Complex Agent å¤„ç†"
                ].join("\n")
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['âŒ ai-failed', 'needs-review']
              });

              core.setFailed(err.message);
            }
