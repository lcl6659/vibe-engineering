name: Complex Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue ç¼–å·"
        required: true
        type: string
  issue_comment:
    types: [created]

jobs:
  complex-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-complex å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request == null &&
        contains(github.event.comment.body, '/agent-complex'))
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      actions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            return { issueNumber, title: issue.title, body: issue.body };

      - name: Load Complex Prompt
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/complex.md
          variables: |
            {
              "title": ${{ toJson(steps.issue_info.outputs.issue_title) }},
              "body": ${{ toJson(steps.issue_info.outputs.issue_body) }}
            }

      - name: Analyze and Create Sub-Issues
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          PROMPT_CONTENT: ${{ steps.prompt.outputs.prompt }}
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};
            const title = ${{ toJson(steps.issue_info.outputs.issue_title) }};
            const body = ${{ toJson(steps.issue_info.outputs.issue_body) }};

            console.log("=".repeat(60));
            console.log("ğŸ“‹ COMPLEX AGENT - æ‹†åˆ†ä»»åŠ¡å¹¶åˆ›å»ºå­ Issue");
            console.log("=".repeat(60));
            console.log(`Issue #${issueNumber}: ${title}`);

            // è°ƒç”¨ OpenRouter è¿›è¡Œä»»åŠ¡æ‹†åˆ†
            const prompt = process.env.PROMPT_CONTENT;
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "anthropic/claude-sonnet-4.5",
                messages: [{ role: "user", content: prompt }],
                temperature: 0.2,
                response_format: { type: "json_object" }
              })
            });

            if (!response.ok) {
              throw new Error(`ä»»åŠ¡æ‹†åˆ†å¤±è´¥: ${response.status}`);
            }

            const data = await response.json();
            let result = data.choices?.[0]?.message?.content || '';
            const jsonMatch = result.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
              result = JSON.parse(jsonMatch[0]);
            } else {
              throw new Error("æ— æ³•è§£æä»»åŠ¡æ‹†åˆ†ç»“æœ");
            }

            const rawTasks = Array.isArray(result.tasks) ? result.tasks : [];
            if (rawTasks.length === 0) {
              throw new Error("ä»»åŠ¡æ‹†åˆ†ç»“æœä¸ºç©º");
            }

            // è§„èŒƒåŒ–ä»»åŠ¡æ•°é‡
            const tasks = rawTasks.slice(0, 8);
            if (tasks.length < 3) {
              console.log(`âš ï¸ ä»»åŠ¡æ•°é‡ä¸è¶³ 3 ä¸ªï¼Œç»§ç»­å¤„ç†å·²æœ‰ ${tasks.length} ä¸ª`);
            }

            // åˆ›å»ºå­ Issue
            const created = [];
            for (let i = 0; i < tasks.length; i++) {
              const task = tasks[i];
              const scope = Array.isArray(task.scope) ? task.scope : [];
              const acceptance = Array.isArray(task.acceptance_criteria) ? task.acceptance_criteria : [];

              const issueBody = [
                `## ğŸ¯ ä»»åŠ¡ç›®æ ‡`,
                task.description || 'æœªæä¾›æè¿°',
                "",
                "## ğŸ§­ ä»»åŠ¡èŒƒå›´",
                scope.length > 0 ? scope.map(s => `- ${s}`).join("\n") : "- unknown",
                "",
                "## âœ… éªŒæ”¶æ ‡å‡†",
                acceptance.length > 0 ? acceptance.map(item => `- [ ] ${item}`).join("\n") : "- [ ] è¡¥å……éªŒæ”¶æ ‡å‡†",
                "",
                `**Parent:** #${issueNumber}`,
                `**å‰ç½®ä¾èµ–:** å¾…å®š`,
                "",
                `> ç”± Complex Agent æ‹†åˆ†ç”Ÿæˆ`
              ].join("\n");

              const { data: subIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Sub] ${task.title || `Task ${i + 1}`}`,
                body: issueBody,
                labels: ['sub-issue']
              });

              created.push({
                index: i,
                task,
                issue: subIssue
              });
            }

            // æ›´æ–°ä¾èµ–å…³ç³»ä¸æ ‡ç­¾
            for (const item of created) {
              const { task, issue } = item;
              const dependsOn = Array.isArray(task.depends_on) ? task.depends_on : [];
              const deps = dependsOn
                .map(depIndex => created.find(c => c.index === depIndex)?.issue.number)
                .filter(Boolean);

              const scope = Array.isArray(task.scope) ? task.scope : [];
              const labels = [];
              const complexity = (task.complexity || 'M').toUpperCase();

              if (complexity === 'S') labels.push('complexity:simple');
              else if (complexity === 'L') labels.push('complexity:complex');
              else labels.push('complexity:medium');

              if (scope.includes('frontend')) labels.push('frontend');
              if (scope.includes('backend')) labels.push('backend');
              if (scope.includes('database')) labels.push('database');
              if (scope.includes('devops')) labels.push('devops');

              if (labels.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels
                });
              }

              const updatedBody = issue.body.replace(
                /(\*\*å‰ç½®ä¾èµ–:\*\*).*/,
                `$1 ${deps.length > 0 ? deps.map(d => `#${d}`).join(' ') : 'æ— '}`
              );

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: updatedBody
              });
            }

            // æ›´æ–°çˆ¶ Issueï¼Œè¿½åŠ å­ Issue åˆ—è¡¨
            const childrenLines = created.map(item => {
              const deps = (item.task.depends_on || [])
                .map(depIndex => created.find(c => c.index === depIndex)?.issue.number)
                .filter(Boolean)
                .map(num => `#${num}`);
              return `- #${item.issue.number} ${item.issue.title} ${deps.length > 0 ? `(ä¾èµ–: ${deps.join(', ')})` : ''}`;
            });

            const parentBody = body || '';
            const sectionHeader = '## å­ Issue åˆ—è¡¨';
            const newSection = [
              sectionHeader,
              "",
              ...childrenLines,
              "",
              `> ç”± Complex Agent è‡ªåŠ¨æ‹†åˆ†ç”Ÿæˆ`
            ].join("\n");

            const updatedParentBody = parentBody.includes(sectionHeader)
              ? parentBody.replace(new RegExp(`${sectionHeader}[\\s\\S]*`, 'm'), newSection)
              : `${parentBody}\n\n${newSection}`;

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: updatedParentBody
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "ğŸ“‹ **Complex Agent - æ‹†åˆ†å®Œæˆ**",
                "",
                `å·²åˆ›å»º ${created.length} ä¸ªå­ Issueï¼š`,
                childrenLines.join("\n"),
                "",
                "å·²æ›´æ–°çˆ¶ Issue çš„å­ä»»åŠ¡åˆ—è¡¨ã€‚",
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Complex Agent å¤„ç†"
              ].join("\n")
            });

            // è§¦å‘ç¬¬ä¸€ä¸ªæ— ä¾èµ–å­ä»»åŠ¡
            const readyTask = created.find(item => (item.task.depends_on || []).length === 0);
            if (readyTask) {
              const complexity = (readyTask.task.complexity || 'M').toUpperCase();
              let agentWorkflow = 'agent-medium.yml';
              if (complexity === 'S') agentWorkflow = 'agent-simple.yml';
              else if (complexity === 'L') agentWorkflow = 'agent-complex.yml';

              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: agentWorkflow,
                ref: 'main',
                inputs: {
                  issue_number: String(readyTask.issue.number)
                }
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: readyTask.issue.number,
                body: [
                  "ğŸš€ **å­ä»»åŠ¡å·²è‡ªåŠ¨å¯åŠ¨**",
                  "",
                  `å·²è§¦å‘ \`${agentWorkflow}\` å¼€å§‹æ‰§è¡Œã€‚`,
                  "",
                  "> ğŸ¤– ç”± Vibe Complex Agent è‡ªåŠ¨è§¦å‘"
                ].join("\n")
              });
            }
