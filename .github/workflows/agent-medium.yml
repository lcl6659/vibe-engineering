name: Medium Task Agent

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue ç¼–å·'
        required: true
        type: string
      continuation_context:
        description: 'ç»§ç»­è¿­ä»£çš„ä¸Šä¸‹æ–‡ä¿¡æ¯'
        required: false
        type: string
  issue_comment:
    types: [created]

jobs:
  medium-task:
    # é€šè¿‡ workflow_callã€workflow_dispatch æˆ– /agent-medium å‘½ä»¤è§¦å‘
    if: |
      github.event_name == 'workflow_call' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.comment.body, '/agent-medium')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "vibe-medium-agent"
          git config user.email "agent@vibe.bot"

      - name: Get Issue Info
        id: issue_info
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber;
            let issue;

            if (context.eventName === 'workflow_dispatch') {
              // workflow_dispatch è§¦å‘æ—¶ä» inputs è·å–
              issueNumber = parseInt('${{ github.event.inputs.issue_number }}');
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            } else {
              // issue_comment æˆ– workflow_call è§¦å‘
              issue = context.payload.issue;
              issueNumber = issue.number;
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_body', issue.body || '');

            // å­˜å‚¨åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            return { issueNumber, title: issue.title, body: issue.body };

      - name: Update Issue Status
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            // æ›´æ–°æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'complexity:medium'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['ğŸ¤– ai-processing', 'agent:medium']
            });

            // å‘å¸ƒå¼€å§‹åˆ†æçš„è¯„è®º
            const continuationContext = '${{ github.event.inputs.continuation_context }}' || '';
            const isContination = continuationContext.length > 0;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: isContination ? [
                "ğŸ”„ **Medium Agent ç»§ç»­è¿­ä»£**",
                "",
                "**ä¸Šä¸‹æ–‡**: " + continuationContext,
                "",
                "> ğŸ”§ åŸºäºä¹‹å‰çš„è¿›åº¦ç»§ç»­å¼€å‘..."
              ].join("\n") : [
                "ğŸ”§ **Medium Agent å¯åŠ¨**",
                "",
                "**é˜¶æ®µ 1/2**: åˆ†æéœ€æ±‚å¹¶åˆ¶å®šå¼€å‘è®¡åˆ’...",
                "",
                "> ğŸ’¡ ä¸­ç­‰ä»»åŠ¡ä¼šå…ˆåˆ†æå†å¼€å‘ï¼Œç¡®ä¿æ–¹æ¡ˆåˆç†ã€‚"
              ].join("\n")
            });

      - name: Load Prompt Template
        id: prompt
        uses: ./.github/actions/load-prompt
        with:
          template: agents/medium.md
          variables: |
            {
              "repository": "${{ github.repository }}",
              "issue_number": "${{ steps.issue_info.outputs.issue_number }}",
              "title": ${{ toJson(steps.issue_info.outputs.issue_title) }},
              "body": ${{ toJson(steps.issue_info.outputs.issue_body) }},
              "continuation_context": "${{ github.event.inputs.continuation_context || '' }}"
            }

      - name: Run Claude Code Action
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          # track_progress only supported for issue_comment events, not workflow_dispatch
          track_progress: ${{ github.event_name == 'issue_comment' }}
          prompt: ${{ steps.prompt.outputs.prompt }}
          claude_args: |
            --model anthropic/claude-sonnet-4
            --max-turns 50

      - name: Update Issue on Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            // ç§»é™¤ processing æ ‡ç­¾ï¼Œæ·»åŠ  completed æ ‡ç­¾
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âœ… ai-completed']
            });

            // å‘å¸ƒæˆåŠŸè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "âœ… **Medium Agent å®Œæˆ**",
                "",
                "éœ€æ±‚åˆ†æå’Œä»£ç å®ç°å·²å®Œæˆï¼ŒPR å·²åˆ›å»ºã€‚",
                "",
                "è¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¿›åº¦è¿½è¸ªè¯„è®ºè·å– PR é“¾æ¥ã€‚",
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Medium Agent è‡ªåŠ¨å¤„ç†"
              ].join("\n")
            });

      - name: Update Issue on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.issue_info.outputs.issue_number }};

            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'ğŸ¤– ai-processing'
              });
            } catch (e) {}

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['âŒ ai-failed', 'needs-review']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                "âŒ **Medium Agent å¤±è´¥**",
                "",
                "è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚",
                "",
                "**å¯èƒ½çš„åŸå› :**",
                "- éœ€æ±‚æè¿°ä¸å¤Ÿæ¸…æ™°",
                "- æ¶‰åŠçš„æ¨¡å—è¿‡å¤š",
                "- æŠ€æœ¯æ–¹æ¡ˆéœ€è¦äººå·¥ç¡®è®¤",
                "",
                "**è§£å†³æ–¹æ¡ˆ:**",
                "- è¡¥å……éœ€æ±‚æè¿°åä½¿ç”¨ `/agent-medium` é‡è¯•",
                "- æˆ–å°†ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªç®€å•ä»»åŠ¡",
                "- æˆ–ä½¿ç”¨ `/agent-complex` è®© AI å…ˆæ‹†åˆ†ä»»åŠ¡",
                "",
                "---",
                "> ğŸ¤– ç”± Vibe Medium Agent å¤„ç†"
              ].join("\n")
            });
