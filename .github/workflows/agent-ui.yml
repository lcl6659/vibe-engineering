name: Vibe UI Agent

on:
  issue_comment:
    types: [created]

jobs:
  ui-agent:
    if: |
      contains(github.event.comment.body, '/agent-ui') ||
      contains(github.event.comment.body, '/agent ui')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Vibe UI Agent - Generate UI Spec
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        with:
          script: |
            async function runUIAgent() {
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const issue_number = context.issue.number;
              const commentBody = context.payload.comment.body || "";

              // æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤
              const userExtra = commentBody
                .replace(/\/agent-ui\b/i, "")
                .replace(/\/agent ui\b/i, "")
                .trim();

              const pmRaw = [
                "PRD TITLE:",
                process.env.ISSUE_TITLE || "",
                "",
                "PRD BODY:",
                process.env.ISSUE_BODY || ""
              ].join("\n");

              // ==================== Step 1: PM Compiler ====================
              console.log("Step 1: è¿è¡Œ PM Compilerï¼Œå°† PRD è½¬æ¢ä¸º AI å¯æ‰§è¡ŒæŒ‡ä»¤...");
              
              const pmPrompt = [
                "ä½ æ˜¯ä¸€ä¸ªã€éœ€æ±‚ç¼–è¯‘å™¨ï¼ˆPM Requirement Compilerï¼‰ã€‘ã€‚",
                "",
                "ä½ çš„èŒè´£ä¸æ˜¯ã€Œç†è§£éœ€æ±‚ã€ï¼Œè€Œæ˜¯å°†ã€äººç±» PM ç¼–å†™çš„éœ€æ±‚æ–‡æœ¬ã€‘è½¬æ¢ä¸ºã€AI å¯æ‰§è¡Œã€ä¸å¯æ­§ä¹‰çš„æŒ‡ä»¤åˆåŒã€‘ã€‚",
                "ä½ å¿…é¡»å‡è®¾åŸå§‹ PM æ–‡æ¡£å¯èƒ½ä¸å®Œæ•´ã€å¯èƒ½å­˜åœ¨æ­§ä¹‰ã€å¯èƒ½æ··åˆç›®æ ‡/æ–¹æ¡ˆ/å®ç°çŒœæµ‹ã€‚",
                "",
                "ä½ çš„ç›®æ ‡ï¼š",
                "- æ¶ˆé™¤æ­§ä¹‰",
                "- å†»ç»“äº‹å®",
                "- æ˜ç¡®ç¦æ­¢é¡¹",
                "- ç”Ÿæˆä¸€ä¸ªã€Œä¸‹æ¸¸ Agent ä¸éœ€è¦å†åšè®¾è®¡å†³ç­–ã€çš„æ‰§è¡Œ Prompt",
                "- ä¸å¾—æ–°å¢åŸéœ€æ±‚é‡Œä¸å­˜åœ¨çš„æ–°åŠŸèƒ½",
                "",
                "====================",
                "è¾“å…¥ï¼ˆPM åŸå§‹éœ€æ±‚ï¼‰",
                "====================",
                pmRaw,
                "",
                userExtra ? "====================\nç”¨æˆ·é¢å¤–æŒ‡ä»¤\n====================\n" + userExtra + "\n" : "",
                "====================",
                "å¼ºåˆ¶å¤„ç†æ­¥éª¤",
                "====================",
                "Step 1ï¼šæå–ã€äº§å“ç›®æ ‡ã€‘ï¼ˆä¸€å¥è¯ï¼Œä¸å«æ–¹æ¡ˆç»†èŠ‚ï¼‰",
                "Step 2ï¼šæå–ã€æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œã€‘ï¼ˆç”¨æˆ·åšä»€ä¹ˆ â†’ ç³»ç»Ÿå¿…é¡»å‘ç”Ÿä»€ä¹ˆï¼‰",
                "Step 3ï¼šå†»ç»“ã€è¾“å…¥è§„åˆ™ã€‘ï¼ˆä½ç½®/å½¢å¼/æ•°é‡é™åˆ¶ï¼‰",
                "Step 4ï¼šå†»ç»“ã€è¾“å‡ºè§„åˆ™ã€‘ï¼ˆå½¢æ€/ä½ç½®/ç»“æ„/é¡ºåºçº¦æŸï¼‰",
                "Step 5ï¼šå†»ç»“ã€è§’è‰²èŒè´£ã€‘ï¼ˆLLM ç”ŸæˆèŒƒå›´ã€æ˜¯å¦å…è®¸ç³»ç»Ÿç»•è¿‡ LLMï¼‰",
                "Step 6ï¼šç”Ÿæˆã€ç¦æ­¢è¡Œä¸ºåˆ—è¡¨ã€‘ï¼ˆAI ç»å¯¹ä¸èƒ½åšçš„äº‹ï¼‰",
                "Step 7ï¼šç”Ÿæˆã€å¼‚å¸¸ä¸è¾¹ç•Œè§„åˆ™ã€‘ï¼ˆå¤±è´¥æ—¶ç”¨æˆ·å¯è§æç¤ºï¼‰",
                "Step 8ï¼šå¤„ç†ã€æ­§ä¹‰ã€‘ï¼ˆé€‰æ‹©ä¸€ç§æœ€ä¿å®ˆè§£é‡Šå¹¶è®°å½•ï¼Œä¸å¾—ä¿ç•™å¤šè§£ï¼‰",
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼ï¼‰",
                "====================",
                "å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡º JSONï¼Œä¸å¾—æ–°å¢æˆ–åˆ å‡å­—æ®µï¼š",
                "",
                "{",
                '  "product_goal": "äº§å“ç›®æ ‡ï¼ˆä¸€å¥è¯ï¼‰",',
                '  "page_type": "new_page æˆ– existing_pageï¼ˆåˆ¤æ–­æ˜¯æ–°å»ºé¡µé¢è¿˜æ˜¯ä¿®æ”¹ç°æœ‰é¡µé¢ï¼‰",',
                '  "target_page": "ç›®æ ‡é¡µé¢è·¯å¾„ï¼Œå¦‚ frontend/app/page.tsx",',
                '  "user_actions": ["ç”¨æˆ·åŠ¨ä½œ1 â†’ ç³»ç»Ÿååº”", "ç”¨æˆ·åŠ¨ä½œ2 â†’ ç³»ç»Ÿååº”"],',
                '  "input_rules": ["è¾“å…¥è§„åˆ™1", "è¾“å…¥è§„åˆ™2"],',
                '  "output_rules": ["è¾“å‡ºè§„åˆ™1", "è¾“å‡ºè§„åˆ™2"],',
                '  "ui_facts": ["UIäº‹å®1", "UIäº‹å®2"],',
                '  "llm_responsibilities": ["LLMèŒè´£1", "LLMèŒè´£2"],',
                '  "forbidden_actions": ["ç¦æ­¢è¡Œä¸º1", "ç¦æ­¢è¡Œä¸º2"],',
                '  "edge_cases": ["å¼‚å¸¸å¤„ç†1", "å¼‚å¸¸å¤„ç†2"],',
                '  "disambiguation_notes": ["æ­§ä¹‰å¤„ç†è¯´æ˜1", "æ­§ä¹‰å¤„ç†è¯´æ˜2"]',
                "}",
                "",
                "åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚",
                "",
                "ã€å…³é”®çº¦æŸã€‘",
                "- ç¦æ­¢å‘ç”¨æˆ·æé—®æˆ–è¯·æ±‚æ¾„æ¸…",
                "- é‡åˆ°æ­§ä¹‰æ—¶ï¼Œå¿…é¡»è‡ªè¡Œé€‰æ‹©æœ€ä¿å®ˆçš„è§£é‡Š",
                "- æ— è®ºéœ€æ±‚å¤šä¹ˆæ¨¡ç³Šï¼Œéƒ½å¿…é¡»è¾“å‡ºå®Œæ•´çš„ JSON ç»“æ„",
                "- åœ¨ disambiguation_notes ä¸­è®°å½•ä½ çš„è§£é‡Šå†³ç­–"
              ].join("\n");

              const pmRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: pmPrompt }],
                  temperature: 0.3
                })
              });

              if (!pmRes.ok) {
                const err = await pmRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **PM Compiler è¯·æ±‚å¤±è´¥**\n\nHTTP: " + pmRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("PM Compiler failed: " + pmRes.status);
              }

              const pmData = await pmRes.json();
              const pmRawContent = pmData?.choices?.[0]?.message?.content || "";
              
              // è§£æ PM Compiler è¾“å‡ºçš„ JSON
              let pmResult;
              try {
                let jsonStr = pmRawContent.trim();
                const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (jsonMatch) {
                  jsonStr = jsonMatch[1].trim();
                } else {
                  const firstBrace = jsonStr.indexOf("{");
                  const lastBrace = jsonStr.lastIndexOf("}");
                  if (firstBrace !== -1 && lastBrace !== -1) {
                    jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                  }
                }
                pmResult = JSON.parse(jsonStr);
                console.log("âœ… PM Compiler è¾“å‡ºè§£ææˆåŠŸ");
              } catch (e) {
                console.error("PM Compiler JSON è§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬");
                console.error("åŸå§‹å†…å®¹:", pmRawContent.substring(0, 500));
                
                // å¦‚æœæ¨¡å‹è¿”å›äº†è¯¢é—®è€Œä¸æ˜¯ JSONï¼Œç›´æ¥æŠ¥é”™
                if (pmRawContent.includes("è¯·ç¡®è®¤") || pmRawContent.includes("è¯·æ˜ç¡®") || pmRawContent.includes("è¯·å‘Šè¯‰æˆ‘")) {
                  await github.rest.issues.createComment({
                    owner, repo, issue_number,
                    body: [
                      "âš ï¸ **PM Compiler éœ€è¦æ›´æ˜ç¡®çš„éœ€æ±‚**",
                      "",
                      "æ¨¡å‹è®¤ä¸ºéœ€æ±‚å­˜åœ¨æ­§ä¹‰ï¼Œè¯·åœ¨ Issue ä¸­è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š",
                      "",
                      pmRawContent,
                      "",
                      "---",
                      "è¡¥å……ä¿¡æ¯åï¼Œå†æ¬¡æ‰§è¡Œ `/agent-ui`"
                    ].join("\n")
                  });
                  throw new Error("éœ€æ±‚å­˜åœ¨æ­§ä¹‰ï¼Œå·²è¯·æ±‚ç”¨æˆ·æ¾„æ¸…");
                }
                
                pmResult = { raw: pmRawContent };
              }

              // ==================== Step 1.5: è¯»å–ç°æœ‰é¡µé¢å†…å®¹ï¼ˆå¦‚æœæ˜¯ä¿®æ”¹é¡µé¢ï¼‰====================
              let existingPageContent = "";
              let existingPagePath = "";
              
              if (pmResult.page_type === "existing_page" && pmResult.target_page) {
                existingPagePath = pmResult.target_page;
                console.log("æ£€æµ‹åˆ°ä¿®æ”¹ç°æœ‰é¡µé¢ï¼Œæ­£åœ¨è¯»å–: " + existingPagePath);
                
                const fs = require('fs');
                const path = require('path');
                
                try {
                  // å°è¯•è¯»å–ç›®æ ‡é¡µé¢
                  const fullPath = path.join(process.cwd(), existingPagePath);
                  if (fs.existsSync(fullPath)) {
                    existingPageContent = fs.readFileSync(fullPath, 'utf-8');
                    console.log("âœ… æˆåŠŸè¯»å–ç°æœ‰é¡µé¢ï¼Œé•¿åº¦: " + existingPageContent.length + " å­—ç¬¦");
                  } else {
                    console.log("âš ï¸ ç›®æ ‡é¡µé¢ä¸å­˜åœ¨: " + fullPath);
                  }
                } catch (e) {
                  console.error("è¯»å–é¡µé¢å¤±è´¥:", e.message);
                }
                
                // åŒæ—¶è¯»å–ç›¸å…³ç»„ä»¶ï¼ˆå¦‚æœé¡µé¢ä¸­æœ‰ importï¼‰
                if (existingPageContent) {
                  const importMatches = existingPageContent.match(/from\s+['"]@\/components\/([^'"]+)['"]/g) || [];
                  const componentFiles = importMatches.map(m => {
                    const match = m.match(/from\s+['"]@\/components\/([^'"]+)['"]/);
                    return match ? "frontend/components/" + match[1] + (match[1].endsWith('.tsx') ? '' : '.tsx') : null;
                  }).filter(Boolean);
                  
                  for (const compFile of componentFiles.slice(0, 5)) { // æœ€å¤šè¯»å–5ä¸ªç»„ä»¶
                    try {
                      const compPath = path.join(process.cwd(), compFile);
                      if (fs.existsSync(compPath)) {
                        const compContent = fs.readFileSync(compPath, 'utf-8');
                        existingPageContent += "\n\n// ===== " + compFile + " =====\n" + compContent;
                        console.log("âœ… è¯»å–å…³è”ç»„ä»¶: " + compFile);
                      }
                    } catch (e) {
                      // å¿½ç•¥è¯»å–å¤±è´¥çš„ç»„ä»¶
                    }
                  }
                }
              }

              // ==================== Step 2: UI Spec Generator ====================
              console.log("Step 2: è¿è¡Œ UI Spec Generatorï¼Œç”Ÿæˆ Frozen UI Spec...");

              // æ ¼å¼åŒ– PM ç»“æœä¸º UI Agent å¯ç”¨çš„è¾“å…¥
              let compiledRequirement;
              if (pmResult.raw) {
                compiledRequirement = pmRawContent;
              } else {
                compiledRequirement = [
                  "## äº§å“ç›®æ ‡",
                  pmResult.product_goal || "æœªå®šä¹‰",
                  "",
                  "## é¡µé¢ç±»å‹",
                  pmResult.page_type === "new_page" ? "**æ–°é¡µé¢** - åˆ›å»ºå…¨æ–°é¡µé¢" : "**ç°æœ‰é¡µé¢** - åœ¨ç°æœ‰é¡µé¢ä¸Šä¿®æ”¹/æ–°å¢åŠŸèƒ½",
                  "",
                  "## ç›®æ ‡é¡µé¢",
                  pmResult.target_page || "frontend/app/page.tsx",
                  "",
                  "## æ ¸å¿ƒç”¨æˆ·åŠ¨ä½œ",
                  (pmResult.user_actions || []).map((a, i) => (i + 1) + ". " + a).join("\n"),
                  "",
                  "## è¾“å…¥è§„åˆ™",
                  (pmResult.input_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## è¾“å‡ºè§„åˆ™",
                  (pmResult.output_rules || []).map(r => "- " + r).join("\n"),
                  "",
                  "## UI äº‹å®",
                  (pmResult.ui_facts || []).map(f => "- " + f).join("\n"),
                  "",
                  "## LLM èŒè´£",
                  (pmResult.llm_responsibilities || []).map(r => "- " + r).join("\n"),
                  "",
                  "## ç¦æ­¢è¡Œä¸º",
                  (pmResult.forbidden_actions || []).map(f => "- " + f).join("\n"),
                  "",
                  "## å¼‚å¸¸ä¸è¾¹ç•Œ",
                  (pmResult.edge_cases || []).map(e => "- " + e).join("\n"),
                  "",
                  "## æ­§ä¹‰å¤„ç†è¯´æ˜",
                  (pmResult.disambiguation_notes || []).map(n => "- " + n).join("\n")
                ].join("\n");
              }

              // æ„å»ºç°æœ‰é¡µé¢ä¸Šä¸‹æ–‡
              let existingPageContext = "";
              if (existingPageContent) {
                existingPageContext = [
                  "",
                  "====================",
                  "âš ï¸ ç°æœ‰é¡µé¢ä»£ç ï¼ˆå¿…é¡»ä¿ç•™ï¼‰",
                  "====================",
                  "ä»¥ä¸‹æ˜¯ç›®æ ‡é¡µé¢çš„ç°æœ‰ä»£ç ï¼Œä½ å¿…é¡»ï¼š",
                  "1. å®Œæ•´ä¿ç•™ç°æœ‰çš„æ‰€æœ‰åŠŸèƒ½å’Œç»„ä»¶",
                  "2. ä¿ç•™ç°æœ‰çš„å¸ƒå±€ç»“æ„",
                  "3. æ–°åŠŸèƒ½åº”è¯¥ä½œä¸ºå¢é‡æ·»åŠ ï¼Œè€Œä¸æ˜¯æ›¿æ¢",
                  "4. åœ¨è§„æ ¼ä¸­æ˜ç¡®æ ‡æ³¨å“ªäº›æ˜¯ã€Œç°æœ‰åŠŸèƒ½ã€å“ªäº›æ˜¯ã€Œæ–°å¢åŠŸèƒ½ã€",
                  "",
                  "```tsx",
                  existingPageContent.substring(0, 8000), // é™åˆ¶é•¿åº¦é¿å… token è¶…é™
                  existingPageContent.length > 8000 ? "\n// ... ä»£ç è¿‡é•¿å·²æˆªæ–­ ..." : "",
                  "```",
                  ""
                ].join("\n");
              }

              const uiPrompt = [
                "ä½ æ˜¯å‰ç«¯å·¥ç¨‹è§„æ ¼ç”Ÿæˆå™¨ã€‚",
                "",
                "å°†éœ€æ±‚è½¬æ¢ä¸ºã€å¯ç›´æ¥ç¼–ç çš„å·¥ç¨‹è§„æ ¼ã€‘ï¼Œå‰ç«¯ Agent ä¼šæ ¹æ®è¿™ä¸ªè§„æ ¼ç”Ÿæˆä»£ç ã€‚",
                existingPageContent ? "\nâš ï¸ **é‡è¦ï¼šè¿™æ˜¯å¯¹ç°æœ‰é¡µé¢çš„ä¿®æ”¹ï¼Œå¿…é¡»ä¿ç•™æ‰€æœ‰ç°æœ‰åŠŸèƒ½å’Œå¸ƒå±€ï¼**\n" : "",
                "====================",
                "å¯ç”¨çš„ shadcn/ui ç»„ä»¶åº“",
                "====================",
                "é¡¹ç›®å·²é›†æˆ shadcn/uiï¼Œå¿…é¡»ä¼˜å…ˆä½¿ç”¨ä»¥ä¸‹ç°æœ‰ç»„ä»¶ï¼Œä¸è¦é‡å¤é€ è½®å­ï¼š",
                "",
                "**å¸ƒå±€ç±»**: Card, Accordion, Collapsible, Tabs, Separator, Resizable, ScrollArea, AspectRatio",
                "**è¡¨å•ç±»**: Button, Input, Textarea, Checkbox, RadioGroup, Select, Switch, Slider, Form, Field, Label, InputOTP, InputGroup",
                "**åé¦ˆç±»**: Alert, AlertDialog, Dialog, Drawer, Sheet, Popover, HoverCard, Tooltip, Sonner(toast), Progress, Skeleton, Spinner, Empty",
                "**å¯¼èˆªç±»**: Breadcrumb, NavigationMenu, Menubar, DropdownMenu, ContextMenu, Command, Pagination, Sidebar",
                "**æ•°æ®å±•ç¤ºç±»**: Avatar, Badge, Table, Calendar, Carousel, Chart, Kbd",
                "**äº¤äº’ç±»**: Toggle, ToggleGroup, ButtonGroup",
                "",
                "å¯¼å…¥æ–¹å¼: import { ComponentName } from '@/components/ui/component-name'",
                "",
                "====================",
                "éœ€æ±‚",
                "====================",
                compiledRequirement,
                existingPageContext,
                "",
                "====================",
                "è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼éµå¾ªï¼Œä¸è¦æ·»åŠ å…¶ä»–ç« èŠ‚ï¼‰",
                "====================",
                "",
                "## æ“ä½œç±»å‹",
                "æ˜ç¡®æŒ‡å®šï¼šNEW_PAGEï¼ˆæ–°å»ºé¡µé¢ï¼‰æˆ– MODIFY_PAGEï¼ˆä¿®æ”¹ç°æœ‰é¡µé¢ï¼‰",
                "",
                "## ç›®æ ‡é¡µé¢",
                "- è·¯å¾„ï¼šfrontend/app/xxx/page.tsx",
                "- å¦‚æœæ˜¯ MODIFY_PAGEï¼Œå¿…é¡»è¯¦ç»†è¯´æ˜è¦ä¿ç•™çš„ç°æœ‰åŠŸèƒ½",
                "",
                "## ç°æœ‰åŠŸèƒ½æ¸…å•ï¼ˆä»… MODIFY_PAGE éœ€è¦ï¼‰",
                "å¦‚æœæ˜¯ä¿®æ”¹ç°æœ‰é¡µé¢ï¼Œå¿…é¡»åˆ—å‡ºï¼š",
                "- ã€ä¿ç•™ã€‘ç°æœ‰ç»„ä»¶1: åŠŸèƒ½æè¿°",
                "- ã€ä¿ç•™ã€‘ç°æœ‰ç»„ä»¶2: åŠŸèƒ½æè¿°", 
                "- ã€ä¿ç•™ã€‘ç°æœ‰å¸ƒå±€ç»“æ„: æè¿°",
                "- ã€æ–°å¢ã€‘æ–°åŠŸèƒ½: æè¿°",
                "",
                "## shadcn/ui ç»„ä»¶ä½¿ç”¨",
                "åˆ—å‡ºéœ€è¦ä½¿ç”¨çš„ shadcn/ui ç»„ä»¶åŠç”¨é€”ï¼š",
                "- Button: ç”¨äºæäº¤/æ“ä½œæŒ‰é’®",
                "- Card: ç”¨äºå†…å®¹å¡ç‰‡å±•ç¤º",
                "- Dialog: ç”¨äºå¼¹çª—ç¡®è®¤",
                "- ...",
                "",
                "## æ–‡ä»¶ç»“æ„",
                "åˆ—å‡ºéœ€è¦åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶ï¼š",
                "- frontend/app/xxx/page.tsxï¼ˆé¡µé¢ï¼‰",
                "- frontend/components/xxx.tsxï¼ˆä¸šåŠ¡ç»„ä»¶ï¼Œç»„åˆ shadcn/ui ç»„ä»¶ï¼‰",
                "",
                "## ç»„ä»¶æ¸…å•",
                "æ¯ä¸ªã€ä¸šåŠ¡ç»„ä»¶ã€‘ç”¨ä»¥ä¸‹æ ¼å¼ï¼ˆä¸éœ€è¦åˆ—å‡º shadcn/ui åŸºç¡€ç»„ä»¶ï¼‰ï¼š",
                "",
                "### ComponentName",
                "- æ–‡ä»¶: frontend/components/xxx.tsx",
                "- åŠŸèƒ½: ä¸€å¥è¯æè¿°è¿™ä¸ªç»„ä»¶åšä»€ä¹ˆ",
                "- ä½¿ç”¨çš„ shadcn/ui ç»„ä»¶: Button, Card, Input ç­‰",
                "- Props: { propName: type }",
                "- State: { stateName: type }",
                "- äº‹ä»¶: onClick/onSubmit ç­‰è§¦å‘ä»€ä¹ˆ",
                "- API: è°ƒç”¨å“ªä¸ªæ¥å£ï¼ˆå¦‚æœ‰ï¼‰",
                "",
                "## é¡µé¢ç»„è£…",
                "ä¸»é¡µé¢å¦‚ä½•ç»„è£…è¿™äº›ç»„ä»¶ï¼š",
                "```",
                "<MainLayout>",
                "  <Header />",
                "  <ContentArea />",
                "  <Sidebar />",
                "</MainLayout>",
                "```",
                "",
                "## çŠ¶æ€æµè½¬",
                "| çŠ¶æ€ | è§¦å‘ | ç»“æœ |",
                "|------|------|------|",
                "",
                "## çº¦æŸ",
                "- å¿…é¡»å®ç°çš„åŠŸèƒ½ç‚¹",
                "- ç¦æ­¢åšçš„äº‹æƒ…",
                "- å¦‚æœæ˜¯ MODIFY_PAGEï¼Œåˆ—å‡ºå¿…é¡»ä¿ç•™çš„ç°æœ‰åŠŸèƒ½",
                "",
                "====================",
                "è§„åˆ™",
                "====================",
                "- åªè¾“å‡ºå·¥ç¨‹è§„æ ¼ï¼Œä¸è¦å†™ä»£ç ",
                "- **å¿…é¡»ä¼˜å…ˆä½¿ç”¨ shadcn/ui ç»„ä»¶ï¼Œç¦æ­¢é‡å¤å®ç°å·²æœ‰ç»„ä»¶çš„åŠŸèƒ½**",
                "- æ–‡ä»¶ç»“æ„ä¸­å¿…é¡»åŒ…å« frontend/app/page.tsx",
                "- é¡µé¢ç»„è£…éƒ¨åˆ†å¿…é¡»æ˜ç¡®è¯´æ˜å¦‚ä½•åœ¨ page.tsx ä¸­ä½¿ç”¨ç»„ä»¶",
                "- ä¸è¦å†™'äº¤äº’å“²å­¦'ã€'è®¾è®¡ç†å¿µ'ç­‰æè¿°æ€§æ–‡å­—",
                "- ä¸è¦æè¿°åŠŸèƒ½ï¼Œç›´æ¥å®šä¹‰ç»„ä»¶å’Œæ¥å£",
                "- ä¸è¦ç”Ÿæˆ demo/ç¤ºä¾‹/æ¼”ç¤º ç›¸å…³å†…å®¹",
                "- è¾“å‡ºçš„è§„æ ¼å¿…é¡»è¶³å¤Ÿå…·ä½“ï¼Œè®©ä»£ç  Agent æ— éœ€å†åšå†³ç­–",
                "",
                "**ã€MODIFY_PAGE ç‰¹æ®Šè§„åˆ™ - å¿…é¡»éµå®ˆã€‘**",
                "- å¦‚æœæ˜¯ä¿®æ”¹ç°æœ‰é¡µé¢ï¼Œå¿…é¡»å…ˆåˆ†æç°æœ‰ä»£ç ç»“æ„",
                "- ç¦æ­¢åˆ é™¤æˆ–ä¿®æ”¹ç°æœ‰åŠŸèƒ½ï¼Œåªèƒ½æ–°å¢",
                "- å¿…é¡»ä¿ç•™ç°æœ‰çš„å¸ƒå±€ç»“æ„å’Œç»„ä»¶å±‚çº§",
                "- æ–°åŠŸèƒ½åº”è¯¥ã€Œæ’å…¥ã€åˆ°ç°æœ‰ç»“æ„ä¸­ï¼Œè€Œä¸æ˜¯ã€Œæ›¿æ¢ã€",
                "- åœ¨ç»„ä»¶æ¸…å•ä¸­ç”¨ã€ä¿ç•™ã€‘ã€æ–°å¢ã€‘æ ‡ç­¾åŒºåˆ†",
                "- å¦‚æœç°æœ‰ä»£ç ä½¿ç”¨äº†æŸä¸ªç»„ä»¶/æ ·å¼/æ¨¡å¼ï¼Œæ–°ä»£ç ä¹Ÿåº”è¯¥ä¿æŒä¸€è‡´"
              ].join("\n");

              const uiRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "google/gemini-3-flash-preview",
                  messages: [{ role: "user", content: uiPrompt }],
                  temperature: 0.5
                })
              });

              if (!uiRes.ok) {
                const err = await uiRes.text();
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¯·æ±‚å¤±è´¥**\n\nHTTP: " + uiRes.status + "\n\n```\n" + err.substring(0, 1500) + "\n```"
                });
                throw new Error("UI Spec Generator failed: " + uiRes.status);
              }

              const uiData = await uiRes.json();
              const uiSpec = uiData?.choices?.[0]?.message?.content || "";

              if (!uiSpec.trim()) {
                await github.rest.issues.createComment({
                  owner, repo, issue_number,
                  body: "âŒ **UI Spec Generator è¿”å›ä¸ºç©º**\n\næ¨¡å‹æ²¡æœ‰è¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·é‡è¯•ã€‚"
                });
                throw new Error("UI Spec Generator returned empty content.");
              }

              // ==================== Step 3: Post Result ====================
              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: [
                  "ğŸ”§ **å·¥ç¨‹è§„æ ¼ (Engineering Spec)**",
                  "",
                  "---",
                  "",
                  "## éœ€æ±‚æ‘˜è¦",
                  "",
                  compiledRequirement,
                  "",
                  "---",
                  "",
                  "## å·¥ç¨‹è§„æ ¼",
                  "",
                  uiSpec.trim(),
                  "",
                  "---",
                  "",
                  "**ä¸‹ä¸€æ­¥:**",
                  "å¤åˆ¶æ­¤è¯„è®º URLï¼Œæ‰§è¡Œ `/agent-fe <URL>` ç”Ÿæˆä»£ç "
                ].join("\n")
              });

              console.log("âœ… UI Agent å®Œæˆ");
            }

            await runUIAgent();
