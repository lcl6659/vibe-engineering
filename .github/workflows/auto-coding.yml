name: Auto Coding with Claude

on:
  issues:
    types: [labeled]

jobs:
  coding:
    if: github.event.label.name == 'claude-dev'
    runs-on: ubuntu-latest
    permissions:
      contents: write   # 提交代码权限
      pull-requests: write # 创建 PR 权限
      issues: write     # 修复 403，读取评论权限
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5 # 严格遵循：使用 v5 [cite: 2026-01-06]
        with:
          fetch-depth: 0

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          # 固定标准配置
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          model: anthropic/claude-sonnet-4.5
          track_progress: true
          prompt: |
            I need you to implement a feature based on the technical design in this repository.

            STEP 1: Use 'github:list_issue_comments' to fetch comments for issue #${{ github.event.issue.number }}.
            STEP 2: Locate the most detailed comment from "github-actions" bot that contains a "Technical Design" or "技术架构设计" section.
            STEP 3: Read the Backend Contract (Go) and Frontend Contract (React) in that comment.
            STEP 4: Implement the required code in the current environment.
            
            CONSTRAINTS:
            - NEVER use the nano editor [cite: 2026-01-05].
            - Create a new branch `feat/issue-${{ github.event.issue.number }}`.
            - Follow the Go/React coding standards defined in the design.
            - Push your changes and create a Pull Request.
          # 必须赋予 AI 必要的工具权限以实现通用读取
          allowed_tools: '["github:list_issue_comments", "github:get_issue", "github:create_pull_request", "github:push_changes", "github:comment_on_issue"]'
