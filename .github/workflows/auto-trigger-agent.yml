name: Auto Trigger Agent by Label

on:
  issues:
    types: [labeled]

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      actions: write

    steps:
      - name: Check Label and Trigger Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labelAdded = context.payload.label;
            const issueLabels = issue.labels.map(l => l.name);

            console.log(`Issue #${issue.number}: æ·»åŠ æ ‡ç­¾ "${labelAdded.name}"`);
            console.log(`å½“å‰æ‰€æœ‰æ ‡ç­¾: ${issueLabels.join(', ')}`);

            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¤„ç†ä¸­æˆ–å·²å®Œæˆ
            const skipLabels = ['ğŸ¤– ai-processing', 'âœ… ai-completed', 'âŒ ai-failed'];
            if (skipLabels.some(l => issueLabels.includes(l))) {
              console.log('â­ï¸ Issue å·²åœ¨å¤„ç†ä¸­æˆ–å·²å®Œæˆï¼Œè·³è¿‡');
              return;
            }

            // æ£€æŸ¥å¤æ‚åº¦æ ‡ç­¾
            const hasSimple = issueLabels.includes('complexity:simple');
            const hasMedium = issueLabels.includes('complexity:medium');
            const hasComplex = issueLabels.includes('complexity:complex');

            // åªåœ¨æ·»åŠ å¤æ‚åº¦æ ‡ç­¾æ—¶è§¦å‘
            if (!['complexity:simple', 'complexity:medium', 'complexity:complex'].includes(labelAdded.name)) {
              console.log('â­ï¸ æ·»åŠ çš„æ ‡ç­¾ä¸æ˜¯å¤æ‚åº¦æ ‡ç­¾ï¼Œè·³è¿‡');
              return;
            }

            // ç¡®å®šè¦è§¦å‘çš„ workflow
            let workflowFile = null;
            let agentType = null;

            if (hasSimple) {
              workflowFile = 'agent-simple.yml';
              agentType = 'Simple';
            } else if (hasMedium) {
              workflowFile = 'agent-medium.yml';
              agentType = 'Medium';
            } else if (hasComplex) {
              workflowFile = 'agent-complex.yml';
              agentType = 'Complex';
            }

            if (!workflowFile) {
              console.log('â­ï¸ æ²¡æœ‰åŒ¹é…çš„å¤æ‚åº¦æ ‡ç­¾');
              return;
            }

            // æ£€æŸ¥æœ€è¿‘æ˜¯å¦å·²æœ‰ workflow runï¼ˆé˜²æ­¢ä¸ vibe-router é‡å¤è§¦å‘ï¼‰
            try {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                per_page: 5
              });

              const recentRun = runs.workflow_runs.find(run => {
                const runTime = new Date(run.created_at);
                const timeDiff = Date.now() - runTime.getTime();
                return timeDiff < 60 * 1000; // 1åˆ†é’Ÿå†…å·²æœ‰è¿è¡Œ
              });

              if (recentRun) {
                console.log(`â­ï¸ æ£€æµ‹åˆ°æœ€è¿‘å·²è§¦å‘ (${recentRun.id})ï¼Œè·³è¿‡é‡å¤è§¦å‘`);
                return;
              }
            } catch (e) {
              console.log(`âš ï¸ æ£€æŸ¥é‡å¤è¿è¡Œå¤±è´¥: ${e.message}ï¼Œç»§ç»­è§¦å‘`);
            }

            console.log(`ğŸš€ è§¦å‘ ${agentType} Agent (${workflowFile}) for Issue #${issue.number}`);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflowFile,
                ref: 'main',
                inputs: {
                  issue_number: String(issue.number)
                }
              });

              console.log(`âœ… æˆåŠŸè§¦å‘ ${agentType} Agent`);

              // æ·»åŠ è¯„è®ºé€šçŸ¥
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ¤– **${agentType} Agent å·²è‡ªåŠ¨è§¦å‘**\n\næ£€æµ‹åˆ° \`${labelAdded.name}\` æ ‡ç­¾ï¼Œæ­£åœ¨å¯åŠ¨ AI Agent å¤„ç†æ­¤ä»»åŠ¡...\n\n> ğŸ“Š å¯é€šè¿‡ [Actions](/${context.repo.owner}/${context.repo.repo}/actions) æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€`
              });

            } catch (error) {
              console.error(`âŒ è§¦å‘å¤±è´¥: ${error.message}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âš ï¸ **è‡ªåŠ¨è§¦å‘å¤±è´¥**\n\næ— æ³•è‡ªåŠ¨å¯åŠ¨ Agent: ${error.message}\n\nè¯·æ‰‹åŠ¨ä½¿ç”¨ \`/agent-${agentType.toLowerCase()}\` å‘½ä»¤è§¦å‘ã€‚`
              });
            }
