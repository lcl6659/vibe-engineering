name: Backend Agent

on:
  issue_comment:
    types: [created]

jobs:
  backend-agent:
    if: contains(github.event.comment.body, '/agent-be')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "ai-backend-agent"
          git config user.email "agent@github-actions.bot"

      # ========== æ­¥éª¤ 1ï¼šè§£æå‘½ä»¤å’Œå‡†å¤‡ä¸Šä¸‹æ–‡ ==========
      - name: Parse Command & Prepare Context
        id: prepare
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const commentBody = comment.body;
            
            console.log("=".repeat(80));
            console.log("ğŸ” BACKEND AGENT - è§£æå‘½ä»¤");
            console.log("=".repeat(80));
            
            // 1. æå– UI Spec URLï¼ˆæ”¯æŒ issue å’Œ commentï¼‰
            const urlPattern = /https:\/\/github\.com\/[^\s\)]+\/issues\/\d+(?:#(?:issuecomment-|issue-)\d+)?/g;
            const urls = commentBody.match(urlPattern) || [];

            console.log(`æ‰¾åˆ° ${urls.length} ä¸ª URL`);

            // å¦‚æœæ²¡æœ‰æä¾› URLï¼Œåˆ™é»˜è®¤ä½¿ç”¨å½“å‰ Issue çš„å†…å®¹
            let useCurrentIssue = false;
            if (urls.length === 0) {
              console.log("âš ï¸ æœªæä¾› URLï¼Œå°†ä½¿ç”¨å½“å‰ Issue å†…å®¹ä½œä¸ºéœ€æ±‚");
              useCurrentIssue = true;
            }
            
            // 2. æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤
            let userInstructions = commentBody
              .replace(/\/agent-be\s*/, "")
              .trim();
            
            urls.forEach(url => {
              userInstructions = userInstructions.replace(url, "").trim();
            });
            
            console.log("ç”¨æˆ·æŒ‡ä»¤:", userInstructions || "(æ— )");
            
            // 3. è·å– UI Spec å†…å®¹
            const uiSpecs = [];

            if (useCurrentIssue) {
              // ä½¿ç”¨å½“å‰ Issue çš„å†…å®¹ä½œä¸ºéœ€æ±‚
              const content = issue.body || "";
              const title = issue.title;
              const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issue.number}`;
              uiSpecs.push({ url, content, title });
              console.log(`âœ… ä½¿ç”¨å½“å‰ Issue: ${title}`);
            } else {
              // ä»æä¾›çš„ URL è·å–å†…å®¹
              for (const url of urls) {
                try {
                  const isIssueUrl = !url.includes("#issuecomment-");
                  let content, title;

                  if (isIssueUrl) {
                    const issueNum = url.match(/\/issues\/(\d+)/)[1];
                    const { data } = await github.rest.issues.get({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parseInt(issueNum)
                    });
                    content = data.body || "";
                    title = data.title;
                  } else {
                    const commentId = url.split("#issuecomment-")[1];
                    const { data } = await github.rest.issues.getComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: parseInt(commentId)
                    });
                    content = data.body;
                    title = content.split('\n')[0] || 'UI Spec';
                  }

                  uiSpecs.push({ url, content, title });
                  console.log(`âœ… è·å– UI Spec: ${title}`);
                } catch (error) {
                  console.error(`âŒ è·å–å¤±è´¥: ${url}`);
                  throw error;
                }
              }
            }

            const combinedUISpec = uiSpecs.map((spec, idx) =>
              `## UI Spec ${idx + 1}: ${spec.title}\n\n${spec.content}`
            ).join("\n\n---\n\n");
            
            // 4. ç”Ÿæˆ API Contractï¼ˆä½¿ç”¨ AI æ¨å¯¼ï¼‰
            const contractPrompt = `ä½ æ˜¯åç«¯ API è®¾è®¡ä¸“å®¶ã€‚

            åŸºäºä»¥ä¸‹ UI Specï¼Œæ¨å¯¼æœ€å° API å¥‘çº¦ã€‚
            
            ${userInstructions ? `ç”¨æˆ·è¦æ±‚:\n${userInstructions}\n\n` : ""}
            
            UI Spec:
            ${combinedUISpec}
            
            è¿”å› JSON æ•°ç»„:
            [
              {
                "endpoint": "/api/example",
                "method": "POST",
                "description": "æè¿°",
                "request": { "field": "type" },
                "response": { "field": "type" },
                "errors": [{"code": "CODE", "message": "msg"}]
              }
            ]
            
            åªè¿”å› JSONã€‚`;
            
            const contractRes = await fetch("https://openrouter.ai/api/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENROUTER_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "google/gemini-flash-1.5",
                messages: [{ role: "user", content: contractPrompt }],
                temperature: 0.3
              })
            });
            
            const contractData = await contractRes.json();
            let apiContract = contractData.choices?.[0]?.message?.content || "[]";
            
            // æå– JSON
            const jsonMatch = apiContract.match(/```(?:json)?\s*([\s\S]*?)```/);
            if (jsonMatch) apiContract = jsonMatch[1];
            
            apiContract = JSON.parse(apiContract);
            if (!Array.isArray(apiContract)) apiContract = [apiContract];
            
            console.log(`âœ… API Contract: ${apiContract.length} ä¸ªæ¥å£`);
            
            // 5. è¯»å–é¡¹ç›®æ–‡ä»¶ï¼ˆé€šç”¨ç‰ˆæœ¬ï¼‰
            const systemFiles = [
              "backend/go.mod",
              "backend/CLAUDE.md",
              "backend/cmd/server/main.go",
              "backend/internal/router/router.go",
              "backend/internal/config/config.go",
              "backend/internal/models/video.go",
              "backend/internal/handlers/video.go",
              "backend/internal/repository/video.go"
            ];
            
            const projectContext = {};
            for (const filePath of systemFiles) {
              try {
                const fullPath = path.join(process.cwd(), filePath);
                if (fs.existsSync(fullPath)) {
                  projectContext[filePath] = fs.readFileSync(fullPath, "utf8");
                  console.log(`âœ… è¯»å–: ${filePath}`);
                }
              } catch (e) {
                console.log(`âš ï¸ è·³è¿‡: ${filePath}`);
              }
            }
            
            const projectContextText = Object.entries(projectContext)
              .map(([path, content]) => `## ${path}\n\`\`\`go\n${content}\n\`\`\``)
              .join("\n\n");
            
            // 6. æ„å»º Prompt
            const branchName = `agent-be-${issue.number}-${Date.now()}`;
            
            const prompt = `ä½ æ˜¯åç«¯ä»£ç ç”Ÿæˆä¸“å®¶ã€‚

            ## ä»»åŠ¡
            åŸºäº API Contract å®ç°åç«¯ä»£ç ã€‚
            
            ## API Contract
            ${JSON.stringify(apiContract, null, 2)}
            
            ${userInstructions ? `## ç”¨æˆ·è¦æ±‚\n${userInstructions}\n` : ""}
            
            ## é¡¹ç›®çº¦æŸ
            ${projectContextText || "æ— ç°æœ‰ä»£ç å‚è€ƒ"}
            
            ## è¦æ±‚
            - éµå¾ªç°æœ‰ä»£ç é£æ ¼
            - æ‰€æœ‰æ–‡ä»¶åœ¨ backend/ ç›®å½•ä¸‹
            - ä½¿ç”¨ Go æ ‡å‡†åº“å’Œé¡¹ç›®å·²æœ‰ä¾èµ–
            - åŒ…å«é”™è¯¯å¤„ç†
            - æ·»åŠ æ—¥å¿—è®°å½•
            - åˆ›å»ºåˆ†æ”¯: ${branchName}
            
            è¯·ç”Ÿæˆå®Œæ•´çš„åç«¯å®ç°ã€‚`;
            
            core.setOutput("prompt_content", prompt);
            core.setOutput("branch_name", branchName);
            core.setOutput("api_contract", JSON.stringify(apiContract));
            core.setOutput("spec_urls", urls.join(", "));
            
            console.log("âœ… ä¸Šä¸‹æ–‡å‡†å¤‡å®Œæˆ");

      # ========== æ­¥éª¤ 2ï¼šåˆ›å»ºè¿›åº¦è¯„è®º ==========
      - name: Create Progress Comment
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "ğŸ¤– **Backend Agent å·¥ä½œä¸­**",
                "",
                `ğŸ“‹ UI Spec: ${{ steps.prepare.outputs.spec_urls }}`,
                `ğŸŒ¿ åˆ†æ”¯: \`${{ steps.prepare.outputs.branch_name }}\``,
                "",
                "**è¿›åº¦:**",
                "- [x] è§£æ UI Spec",
                "- [x] ç”Ÿæˆ API Contract",
                "- [ ] ç”Ÿæˆä»£ç ",
                "- [ ] è¿è¡Œæµ‹è¯•",
                "- [ ] åˆ›å»º PR",
                "",
                "_å®æ—¶æ›´æ–°ä¸­..._"
              ].join("\n")
            });
            
            core.setOutput("comment_id", comment.id);

      # ========== æ­¥éª¤ 3ï¼šæ‰§è¡Œ Claude Code Action ==========
      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: ${{ steps.prepare.outputs.prompt_content }}
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 20

      # ========== æ­¥éª¤ 4ï¼šæ›´æ–°è¿›åº¦ ==========
      - name: Update Progress
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            let hasChanges = false;
            try {
              const status = execSync('git status --porcelain', { encoding: 'utf8' });
              hasChanges = status.trim().length > 0;
            } catch (e) {}
            
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.progress.outputs.comment_id }},
              body: [
                "ğŸ¤– **Backend Agent å·¥ä½œä¸­**",
                "",
                `ğŸ“‹ UI Spec: ${{ steps.prepare.outputs.spec_urls }}`,
                `ğŸŒ¿ åˆ†æ”¯: \`${{ steps.prepare.outputs.branch_name }}\``,
                "",
                "**è¿›åº¦:**",
                "- [x] è§£æ UI Spec",
                "- [x] ç”Ÿæˆ API Contract",
                hasChanges ? "- [x] ç”Ÿæˆä»£ç " : "- [ ] ç”Ÿæˆä»£ç ï¼ˆæ— å˜æ›´ï¼‰",
                "- [ ] è¿è¡Œæµ‹è¯•",
                "- [ ] åˆ›å»º PR",
                "",
                hasChanges ? "_æ­£åœ¨æµ‹è¯•..._" : "_æ— ä»£ç å˜æ›´_"
              ].join("\n")
            });

      # ========== æ­¥éª¤ 5ï¼šæµ‹è¯• ==========
      - name: Test Backend Code
        if: success()
        continue-on-error: true
        run: |
          if [ -d "backend" ]; then
            echo "Running tests..."
            go test -C backend ./... -v 2>&1 | tee test-output.txt || true
            
            if [ ${PIPESTATUS[0]} -eq 0 ]; then
              echo "TEST_RESULT=passed" >> $GITHUB_ENV
            else
              echo "TEST_RESULT=failed" >> $GITHUB_ENV
            fi
            
            TEST_OUTPUT=$(cat test-output.txt | tail -50)
            echo "TEST_OUTPUT<<EOF" >> $GITHUB_ENV
            echo "$TEST_OUTPUT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "TEST_RESULT=skipped" >> $GITHUB_ENV
          fi

      # ========== æ­¥éª¤ 6ï¼šåˆ›å»º PR ==========
      - name: Create Pull Request
        if: env.TEST_RESULT != 'skipped'
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ steps.prepare.outputs.branch_name }}
          API_CONTRACT: ${{ steps.prepare.outputs.api_contract }}
          SPEC_URLS: ${{ steps.prepare.outputs.spec_urls }}
          TEST_RESULT: ${{ env.TEST_RESULT }}
          TEST_OUTPUT: ${{ env.TEST_OUTPUT }}
        with:
          script: |
            const { execSync } = require('child_process');
            
            // æäº¤å¹¶æ¨é€
            try {
              execSync('git add .');
              execSync(`git commit -m "feat: backend implementation (#${context.issue.number})"`);
              execSync(`git push origin ${process.env.BRANCH_NAME}`);
            } catch (e) {
              console.log("Commit/push error:", e.message);
            }
            
            // åˆ›å»º PR
            try {
              const apiContract = JSON.parse(process.env.API_CONTRACT);
              const testStatus = process.env.TEST_RESULT === 'passed' ? 'âœ… é€šè¿‡' : 
                                 process.env.TEST_RESULT === 'failed' ? 'âŒ å¤±è´¥' : 'â­ï¸ è·³è¿‡';
              
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Backend: API Implementation (#${context.issue.number})`,
                head: process.env.BRANCH_NAME,
                base: "main",
                body: [
                  "ğŸ¤– **Backend Agent è‡ªåŠ¨ç”Ÿæˆ**",
                  "",
                  `ğŸ“‹ UI Spec: ${process.env.SPEC_URLS}`,
                  "",
                  "### API Contract",
                  "```json",
                  JSON.stringify(apiContract, null, 2),
                  "```",
                  "",
                  `### æµ‹è¯•ç»“æœ: ${testStatus}`,
                  process.env.TEST_RESULT === 'failed' ? [
                    "",
                    "<details>",
                    "<summary>æµ‹è¯•è¾“å‡º</summary>",
                    "",
                    "```",
                    process.env.TEST_OUTPUT,
                    "```",
                    "</details>"
                  ].join("\n") : "",
                  "",
                  "---",
                  `Related to #${context.issue.number}`,
                  "",
                  "âš ï¸ **æ³¨æ„**: æ­¤ PR ä¸ä¼šè‡ªåŠ¨å…³é—­ issueï¼Œè¯·åœ¨å‰åç«¯éƒ½å®Œæˆåæ‰‹åŠ¨å…³é—­"
                ].join("\n")
              });
              
              core.setOutput("pr_url", pr.data.html_url);
              
              // æœ€ç»ˆæ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: ${{ steps.progress.outputs.comment_id }},
                body: [
                  "âœ… **Backend Agent å®Œæˆ**",
                  "",
                  `ğŸ“‹ UI Spec: ${process.env.SPEC_URLS}`,
                  `ğŸŒ¿ åˆ†æ”¯: \`${process.env.BRANCH_NAME}\``,
                  `ğŸ”— PR: ${pr.data.html_url}`,
                  "",
                  "**ç»“æœ:**",
                  "- [x] è§£æ UI Spec",
                  "- [x] ç”Ÿæˆ API Contract",
                  "- [x] ç”Ÿæˆä»£ç ",
                  `- [x] æµ‹è¯• ${testStatus}`,
                  "- [x] åˆ›å»º PR",
                  "",
                  `### API Contract (${apiContract.length} ä¸ªæ¥å£)`,
                  apiContract.map((api, i) => 
                    `${i + 1}. \`${api.method} ${api.endpoint}\` - ${api.description || 'æ— æè¿°'}`
                  ).join("\n"),
                  "",
                  "ğŸ‰ **è¯· review PRï¼**"
                ].join("\n")
              });
              
              // æ›´æ–°æ ‡ç­¾
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'ğŸ¤– ai-processing'
              }).catch(() => {});
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['âœ… ai-completed']
              });
              
            } catch (e) {
              console.error("PR creation failed:", e);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ **PR åˆ›å»ºå¤±è´¥**\n\né”™è¯¯: ${e.message}\n\nåˆ†æ”¯å·²æ¨é€: \`${process.env.BRANCH_NAME}\``
              });
            }

      # ========== å¤±è´¥å¤„ç† ==========
      - name: Handle Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.progress.outputs.comment_id }},
              body: [
                "âŒ **Backend Agent å¤±è´¥**",
                "",
                `ğŸ“‹ UI Spec: ${{ steps.prepare.outputs.spec_urls }}`,
                "",
                "è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚",
                "",
                "å¯èƒ½çš„åŸå› :",
                "- UI Spec ä¸å¤Ÿæ˜ç¡®",
                "- API Contract æ¨å¯¼å¤±è´¥",
                "- ä»£ç ç”Ÿæˆé”™è¯¯",
                "",
                "å»ºè®®: æä¾›æ›´è¯¦ç»†çš„ UI Spec æˆ–æ‰‹åŠ¨æŒ‡å®š API æ¥å£ã€‚"
              ].join("\n")
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ğŸ¤– ai-processing'
            }).catch(() => {});
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['âŒ ai-failed']
            });
