name: Dependency Chain Trigger

# å½“å­ Issue å…³é—­æ—¶ï¼Œæ£€æŸ¥å¹¶è§¦å‘ä¾èµ–é“¾ä¸­çš„ä¸‹ä¸€ä¸ªä»»åŠ¡
on:
  issues:
    types: [closed]

jobs:
  trigger-next-task:
    # åªå¤„ç† sub-issue æ ‡ç­¾çš„ issue
    if: contains(github.event.issue.labels.*.name, 'sub-issue')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      actions: write

    steps:
      - name: Check and Trigger Next Task
        uses: actions/github-script@v7
        with:
          script: |
            const closedIssue = context.payload.issue;
            const closedIssueNumber = closedIssue.number;
            const closedIssueBody = closedIssue.body || '';

            console.log("=".repeat(60));
            console.log("ğŸ”— DEPENDENCY CHAIN TRIGGER");
            console.log("=".repeat(60));
            console.log(`âœ… Issue #${closedIssueNumber} å·²å…³é—­: ${closedIssue.title}`);

            // ä» issue body ä¸­æå– parent issue ç¼–å·
            const parentMatch = closedIssueBody.match(/Parent:\s*#(\d+)/i);
            if (!parentMatch) {
              console.log("â­ï¸ æœªæ‰¾åˆ° Parent Issueï¼Œè·³è¿‡ä¾èµ–é“¾æ£€æŸ¥");
              return;
            }

            const parentIssueNumber = parseInt(parentMatch[1]);
            console.log(`ğŸ“‹ Parent Issue: #${parentIssueNumber}`);

            // è·å–æ‰€æœ‰å…·æœ‰ç›¸åŒ parent çš„ sub-issues
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              labels: 'sub-issue',
              per_page: 100
            });

            // è¿‡æ»¤å‡ºåŒä¸€ä¸ª parent çš„å­ä»»åŠ¡
            const siblingIssues = allIssues.filter(issue => {
              const body = issue.body || '';
              const match = body.match(/Parent:\s*#(\d+)/i);
              return match && parseInt(match[1]) === parentIssueNumber;
            });

            console.log(`ğŸ“Š åŒä¸€ Parent ä¸‹å…±æœ‰ ${siblingIssues.length} ä¸ªå­ä»»åŠ¡`);

            // è§£ææ¯ä¸ª sibling çš„ä¾èµ–å…³ç³»
            const issueMap = new Map(); // number -> { issue, depends_on: [numbers], state }

            for (const issue of siblingIssues) {
              const body = issue.body || '';
              const depends = [];

              // æå–ä¾èµ–ï¼š**å‰ç½®ä¾èµ–:** #123, #124
              const depsMatch = body.match(/å‰ç½®ä¾èµ–[ï¼š:]\s*((?:#\d+(?:,\s*)?)+)/i);
              if (depsMatch) {
                const depNumbers = depsMatch[1].match(/#(\d+)/g);
                if (depNumbers) {
                  for (const dep of depNumbers) {
                    depends.push(parseInt(dep.replace('#', '')));
                  }
                }
              }

              issueMap.set(issue.number, {
                issue: issue,
                depends_on: depends,
                state: issue.state
              });

              console.log(`  - #${issue.number}: ${issue.state}, ä¾èµ–: ${depends.length > 0 ? depends.map(d => '#' + d).join(', ') : 'æ— '}`);
            }

            // æ‰¾å‡ºä¾èµ–åˆšå…³é—­çš„ issue çš„ä»»åŠ¡
            const dependentIssues = [];
            for (const [number, info] of issueMap.entries()) {
              if (info.depends_on.includes(closedIssueNumber) && info.state === 'open') {
                dependentIssues.push(info);
              }
            }

            if (dependentIssues.length === 0) {
              console.log("âœ… æ²¡æœ‰å…¶ä»–ä»»åŠ¡ä¾èµ–æ­¤ Issueï¼Œä¾èµ–é“¾æ£€æŸ¥å®Œæˆ");
              return;
            }

            console.log(`\nğŸ” å‘ç° ${dependentIssues.length} ä¸ªä»»åŠ¡ä¾èµ– #${closedIssueNumber}`);

            // æ£€æŸ¥æ¯ä¸ªä¾èµ–ä»»åŠ¡çš„æ‰€æœ‰å‰ç½®ä¾èµ–æ˜¯å¦éƒ½å·²å…³é—­
            let triggeredCount = 0;

            for (const depInfo of dependentIssues) {
              const depIssue = depInfo.issue;
              const allDeps = depInfo.depends_on;

              console.log(`\nğŸ“Œ æ£€æŸ¥ #${depIssue.number}: ${depIssue.title}`);
              console.log(`   æ‰€æœ‰ä¾èµ–: ${allDeps.map(d => '#' + d).join(', ')}`);

              // æ£€æŸ¥æ‰€æœ‰ä¾èµ–æ˜¯å¦éƒ½å·²å…³é—­
              let allDepsClosed = true;
              for (const depNumber of allDeps) {
                const depState = issueMap.get(depNumber)?.state;
                if (depState !== 'closed') {
                  console.log(`   âŒ ä¾èµ– #${depNumber} æœªå…³é—­ (çŠ¶æ€: ${depState || 'æœªçŸ¥'})`);
                  allDepsClosed = false;
                }
              }

              if (!allDepsClosed) {
                console.log(`   â³ ä¾èµ–æœªå…¨éƒ¨å®Œæˆï¼Œæš‚ä¸è§¦å‘`);
                continue;
              }

              console.log(`   âœ… æ‰€æœ‰ä¾èµ–å·²å…³é—­ï¼Œå‡†å¤‡è§¦å‘ Agent`);

              // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¤„ç†ä¸­
              const labels = depIssue.labels.map(l => l.name);
              if (labels.includes('ğŸ¤– ai-processing')) {
                console.log(`   â­ï¸ å·²åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡`);
                continue;
              }
              if (labels.includes('âœ… ai-completed')) {
                console.log(`   â­ï¸ å·²å®Œæˆï¼Œè·³è¿‡`);
                continue;
              }

              // ç¡®å®š agent ç±»å‹
              let agentWorkflow = 'agent-medium.yml';
              let agentType = 'Medium';

              if (labels.includes('complexity:simple')) {
                agentWorkflow = 'agent-simple.yml';
                agentType = 'Simple';
              } else if (labels.includes('complexity:complex')) {
                agentWorkflow = 'agent-complex.yml';
                agentType = 'Complex';
              }

              // è§¦å‘ agent
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: agentWorkflow,
                  ref: 'main',
                  inputs: {
                    issue_number: String(depIssue.number)
                  }
                });

                console.log(`   ğŸš€ å·²è§¦å‘ ${agentType} Agent for #${depIssue.number}`);

                // å‘è¯„è®ºé€šçŸ¥
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: depIssue.number,
                  body: [
                    `ğŸ”— **ä¾èµ–é“¾è§¦å‘**`,
                    ``,
                    `å‰ç½®ä¾èµ– #${closedIssueNumber} å·²å®Œæˆå¹¶å…³é—­ï¼Œè‡ªåŠ¨å¯åŠ¨ ${agentType} Agentã€‚`,
                    ``,
                    `**å·²å®Œæˆçš„ä¾èµ–:**`,
                    allDeps.map(d => `- âœ… #${d}`).join('\n'),
                    ``,
                    `---`,
                    `> ğŸ“Š å¯é€šè¿‡ [Actions](/${context.repo.owner}/${context.repo.repo}/actions) æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€`
                  ].join('\n')
                });

                triggeredCount++;

              } catch (error) {
                console.error(`   âŒ è§¦å‘å¤±è´¥: ${error.message}`);

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: depIssue.number,
                  body: [
                    `âš ï¸ **è‡ªåŠ¨è§¦å‘å¤±è´¥**`,
                    ``,
                    `å‰ç½®ä¾èµ– #${closedIssueNumber} å·²å®Œæˆï¼Œä½†è‡ªåŠ¨è§¦å‘å¤±è´¥: ${error.message}`,
                    ``,
                    `è¯·æ‰‹åŠ¨ä½¿ç”¨ \`/agent-${agentType.toLowerCase()}\` å‘½ä»¤è§¦å‘ã€‚`
                  ].join('\n')
                });
              }
            }

            // æ±‡æ€»
            console.log("\n" + "=".repeat(60));
            console.log(`ğŸ“Š ä¾èµ–é“¾è§¦å‘å®Œæˆ: æˆåŠŸè§¦å‘ ${triggeredCount} ä¸ªä»»åŠ¡`);
            console.log("=".repeat(60));
