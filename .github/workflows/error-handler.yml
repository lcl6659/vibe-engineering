name: Error Handler

on:
  workflow_run:
    workflows:
      - "Backend Agent"
      - "Vibe Frontend Agent"
      - "Vibe UI Agent"
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

jobs:
  handle-errors:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Collect Error Info
        id: error_info
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            // æŸ¥æ‰¾å…³è”çš„ Issue
            let issueNumber = null;
            const branchMatch = run.head_branch?.match(/issue-(\d+)/);
            if (branchMatch) {
              issueNumber = parseInt(branchMatch[1]);
            }
            if (!issueNumber && run.pull_requests.length > 0) {
              issueNumber = run.pull_requests[0].number;
            }

            // è·å–å¤±è´¥çš„ jobs å’Œæ—¥å¿—
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            // è·å–æ¯ä¸ªå¤±è´¥ job çš„æ—¥å¿—ï¼ˆæˆªå–æœ€åéƒ¨åˆ†ï¼‰
            let errorLogs = [];
            for (const job of failedJobs.slice(0, 2)) { // æœ€å¤š2ä¸ª job
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                // åªä¿ç•™æœ€å 200 è¡Œ
                const logLines = logs.data.split('\n').slice(-200).join('\n');
                errorLogs.push({
                  jobName: job.name,
                  logs: logLines
                });
              } catch (e) {
                errorLogs.push({ jobName: job.name, logs: 'Failed to fetch logs' });
              }
            }

            // ä¿å­˜ç»“æœ
            const result = {
              issueNumber,
              runId: run.id,
              runUrl: run.html_url,
              workflowName: run.name,
              headBranch: run.head_branch,
              event: run.event,
              failedJobs: failedJobs.map(j => j.name),
              errorLogs
            };

            core.setOutput('result', JSON.stringify(result));
            core.setOutput('issue_number', issueNumber || '');
            return result;

      - name: Analyze Error with Claude
        id: analyze
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          direct_prompt: |
            ä½ æ˜¯ä¸€ä¸ª CI/CD é”™è¯¯åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹ GitHub Actions workflow å¤±è´¥çš„åŸå› ï¼Œå¹¶æä¾›ç®€æ´çš„åˆ†ææŠ¥å‘Šã€‚

            ## Workflow ä¿¡æ¯
            - Workflow: ${{ fromJSON(steps.error_info.outputs.result).workflowName }}
            - Branch: ${{ fromJSON(steps.error_info.outputs.result).headBranch }}
            - å¤±è´¥çš„ Jobs: ${{ join(fromJSON(steps.error_info.outputs.result).failedJobs, ', ') }}

            ## é”™è¯¯æ—¥å¿—
            ```
            ${{ toJSON(fromJSON(steps.error_info.outputs.result).errorLogs) }}
            ```

            è¯·è¾“å‡ºä»¥ä¸‹æ ¼å¼çš„åˆ†ææŠ¥å‘Šï¼ˆä½¿ç”¨ä¸­æ–‡ï¼‰ï¼š

            ## ğŸ” é”™è¯¯åˆ†æ

            ### æ ¹æœ¬åŸå› 
            [ä¸€å¥è¯æè¿°æ ¹æœ¬åŸå› ]

            ### é”™è¯¯ç±»å‹
            [é€‰æ‹©ä¸€ä¸ª: é…ç½®é—®é¢˜ | ä»£ç é”™è¯¯ | è¾“å…¥ç¼ºå¤± | æƒé™é—®é¢˜ | ä¸´æ—¶æ•…éšœ | å…¶ä»–]

            ### è¯¦ç»†è¯´æ˜
            [2-3å¥è¯è¯¦ç»†è§£é‡Šé—®é¢˜]

            ### å»ºè®®ä¿®å¤æ–¹æ¡ˆ
            [åˆ—å‡º1-3ä¸ªå…·ä½“çš„ä¿®å¤æ­¥éª¤]

            ### æ˜¯å¦å¯è‡ªåŠ¨ä¿®å¤
            [æ˜¯/å¦] - [åŸå› ]
          allowed_tools: ""
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api

      - name: Post Analysis to Issue
        uses: actions/github-script@v7
        with:
          script: |
            const errorInfo = ${{ steps.error_info.outputs.result }};
            const analysis = `${{ steps.analyze.outputs.response }}`;

            const reportBody = [
              "## âŒ Workflow æ‰§è¡Œå¤±è´¥",
              "",
              `**Workflow:** ${errorInfo.workflowName}`,
              `**è¿è¡Œ ID:** ${errorInfo.runId}`,
              `**è§¦å‘åˆ†æ”¯:** ${errorInfo.headBranch}`,
              `**è§¦å‘äº‹ä»¶:** ${errorInfo.event}`,
              "",
              "### å¤±è´¥çš„ Jobs:",
              ...errorInfo.failedJobs.map(job => `- **${job}**`),
              "",
              `ğŸ”— [æŸ¥çœ‹å®Œæ•´æ—¥å¿—](${errorInfo.runUrl})`,
              "",
              "---",
              "",
              analysis || "_AI åˆ†ææš‚ä¸å¯ç”¨_",
              "",
              "---",
              "_è‡ªåŠ¨ç”Ÿæˆ - Error Handler with AI Analysis_"
            ].join("\n");

            if (errorInfo.issueNumber) {
              // è¯„è®ºåˆ°å…³è”çš„ Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                body: reportBody
              });

              // æ›´æ–°æ ‡ç­¾
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                name: 'ğŸ¤– ai-processing'
              }).catch(() => {});

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                labels: ['âŒ ai-failed', 'ğŸ” analyzed']
              });

              core.setOutput('target_issue', errorInfo.issueNumber);
            } else {
              // åˆ›å»ºæ–° Issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Auto] Workflow å¤±è´¥: ${errorInfo.workflowName}`,
                body: reportBody,
                labels: ['ğŸ› bug', 'ğŸ¤– auto-generated', 'workflow-failure', 'ğŸ” analyzed']
              });

              core.setOutput('target_issue', newIssue.data.number);
            }

      - name: Check if Auto-Fix is Possible
        id: check_fix
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = `${{ steps.analyze.outputs.response }}`;

            // ç®€å•åˆ¤æ–­æ˜¯å¦å¯ä»¥è‡ªåŠ¨ä¿®å¤
            const canAutoFix = analysis.includes('æ˜¯å¦å¯è‡ªåŠ¨ä¿®å¤') &&
                               analysis.includes('æ˜¯') &&
                               !analysis.includes('è¾“å…¥ç¼ºå¤±') &&
                               !analysis.includes('é…ç½®é—®é¢˜');

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»£ç é”™è¯¯
            const isCodeError = analysis.includes('ä»£ç é”™è¯¯');

            core.setOutput('can_auto_fix', canAutoFix && isCodeError);
            return { canAutoFix, isCodeError };

      - name: Trigger Auto-Fix (if applicable)
        if: steps.check_fix.outputs.can_auto_fix == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const errorInfo = ${{ steps.error_info.outputs.result }};

            // è§¦å‘ fix-pr workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'fix-pr.yml',
              ref: 'main',
              inputs: {
                pr_number: String(errorInfo.issueNumber || ''),
                error_context: `Workflow ${errorInfo.workflowName} failed. Check issue for AI analysis.`
              }
            }).catch(e => {
              console.log('Could not trigger auto-fix:', e.message);
            });

            // è¯„è®ºé€šçŸ¥
            if (errorInfo.issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: errorInfo.issueNumber,
                body: 'ğŸ”§ **æ­£åœ¨å°è¯•è‡ªåŠ¨ä¿®å¤...** è¯·ç¨å€™æŸ¥çœ‹ç»“æœã€‚'
              });
            }
