name: Frontend Agent

on:
  issue_comment:
    types: [created]

jobs:
  frontend-agent:
    if: contains(github.event.comment.body, '/agent-fe')
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "ai-frontend-agent"
          git config user.email "agent@github-actions.bot"

      # ========== æ­¥éª¤ 1ï¼šè§£æå‘½ä»¤å’Œå‡†å¤‡ä¸Šä¸‹æ–‡ ==========
      - name: Parse Command & Prepare Context
        id: prepare
        uses: actions/github-script@v7
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const path = require("path");

            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const commentBody = comment.body;

            console.log("=".repeat(80));
            console.log("ğŸ¨ FRONTEND AGENT - è§£æå‘½ä»¤");
            console.log("=".repeat(80));

            // 1. æå– UI Spec URLï¼ˆæ”¯æŒ issue å’Œ commentï¼‰
            const urlPattern = /https:\/\/github\.com\/[^\s\)]+\/issues\/\d+(?:#(?:issuecomment-|issue-)\d+)?/g;
            const urls = commentBody.match(urlPattern) || [];

            console.log(`æ‰¾åˆ° ${urls.length} ä¸ª URL`);

            if (urls.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: [
                  "âŒ **ç¼ºå°‘ UI Spec URL**",
                  "",
                  "**ç”¨æ³•:**",
                  "```",
                  "/agent-fe <ui-spec-url>",
                  "```",
                  "",
                  "**ç¤ºä¾‹:**",
                  "```",
                  "/agent-fe https://github.com/owner/repo/issues/123",
                  "/agent-fe https://github.com/owner/repo/issues/123#issuecomment-456789",
                  "```"
                ].join("\n")
              });
              throw new Error("Missing UI Spec URL");
            }

            // 2. æå–ç”¨æˆ·é¢å¤–æŒ‡ä»¤
            let userInstructions = commentBody
              .replace(/\/agent-fe\s*/, "")
              .trim();

            urls.forEach(url => {
              userInstructions = userInstructions.replace(url, "").trim();
            });

            console.log("ç”¨æˆ·æŒ‡ä»¤:", userInstructions || "(æ— )");

            // 3. è·å– UI Spec å†…å®¹
            const uiSpecs = [];
            for (const url of urls) {
              try {
                const isIssueUrl = !url.includes("#issuecomment-");
                let content, title;

                if (isIssueUrl) {
                  const issueNum = url.match(/\/issues\/(\d+)/)[1];
                  const { data } = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNum)
                  });
                  content = data.body || "";
                  title = data.title;
                } else {
                  const commentId = url.split("#issuecomment-")[1];
                  const { data } = await github.rest.issues.getComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: parseInt(commentId)
                  });
                  content = data.body;
                  title = content.split('\n')[0] || 'UI Spec';
                }

                uiSpecs.push({ url, content, title });
                console.log(`âœ… è·å– UI Spec: ${title}`);
              } catch (error) {
                console.error(`âŒ è·å–å¤±è´¥: ${url}`);
                throw error;
              }
            }

            const combinedUISpec = uiSpecs.map((spec, idx) =>
              `## UI Spec ${idx + 1}: ${spec.title}\n\n${spec.content}`
            ).join("\n\n---\n\n");

            // 4. è¯»å–é¡¹ç›®æ–‡ä»¶
            const systemFiles = [
              "frontend/package.json",
              "frontend/STYLE_GUIDE.md",
              "frontend/next.config.ts",
              "frontend/tsconfig.json",
              "frontend/components.json",
              "frontend/app/layout.tsx",
              "frontend/lib/api/client.ts"
            ];

            const projectContext = {};
            for (const filePath of systemFiles) {
              try {
                const fullPath = path.join(process.cwd(), filePath);
                if (fs.existsSync(fullPath)) {
                  projectContext[filePath] = fs.readFileSync(fullPath, "utf8");
                  console.log(`âœ… è¯»å–: ${filePath}`);
                }
              } catch (e) {
                console.log(`âš ï¸ è·³è¿‡: ${filePath}`);
              }
            }

            const projectContextText = Object.entries(projectContext)
              .map(([path, content]) => `## ${path}\n\`\`\`typescript\n${content}\n\`\`\``)
              .join("\n\n");

            // 5. æ„å»º Prompt
            const branchName = `agent-fe-${issue.number}-${Date.now()}`;

            const prompt = `ä½ æ˜¯å‰ç«¯ä»£ç ç”Ÿæˆä¸“å®¶ã€‚

            ## ä»»åŠ¡
            åŸºäº UI Spec å®ç°å‰ç«¯é¡µé¢å’Œç»„ä»¶ã€‚

            ## UI Spec
            ${combinedUISpec}

            ${userInstructions ? `## ç”¨æˆ·è¦æ±‚\n${userInstructions}\n` : ""}

            ## é¡¹ç›®çº¦æŸ
            ${projectContextText || "æ— ç°æœ‰ä»£ç å‚è€ƒ"}

            ## æŠ€æœ¯æ ˆ
            - Next.js 15 (App Router)
            - React 19
            - TypeScript
            - Tailwind CSS
            - shadcn/ui
            - Base.org è®¾è®¡ç³»ç»Ÿ

            ## è¦æ±‚
            - ä¸¥æ ¼éµå¾ª STYLE_GUIDE.md çš„è®¾è®¡è§„èŒƒ
            - ä½¿ç”¨ shadcn/ui ç»„ä»¶
            - æ‰€æœ‰æ–‡ä»¶åœ¨ frontend/ ç›®å½•ä¸‹
            - ä½¿ç”¨ TypeScript
            - éµå¾ª Base.org çš„æç®€è®¾è®¡å“²å­¦
            - API è°ƒç”¨ä½¿ç”¨ lib/api/client.ts
            - åˆ›å»ºåˆ†æ”¯: ${branchName}

            è¯·ç”Ÿæˆå®Œæ•´çš„å‰ç«¯å®ç°ã€‚`;

            core.setOutput("prompt_content", prompt);
            core.setOutput("branch_name", branchName);
            core.setOutput("spec_urls", urls.join(", "));

            console.log("âœ… ä¸Šä¸‹æ–‡å‡†å¤‡å®Œæˆ");

      # ========== æ­¥éª¤ 2ï¼šåˆ›å»ºè¿›åº¦è¯„è®º ==========
      - name: Create Progress Comment
        id: progress
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: [
                "ğŸ¨ **Frontend Agent å·¥ä½œä¸­**",
                "",
                `ğŸ“‹ UI Spec: ${{ steps.prepare.outputs.spec_urls }}`,
                `ğŸŒ¿ åˆ†æ”¯: \`${{ steps.prepare.outputs.branch_name }}\``,
                "",
                "**è¿›åº¦:**",
                "- [x] è§£æ UI Spec",
                "- [ ] ç”Ÿæˆç»„ä»¶ä»£ç ",
                "- [ ] åˆ›å»ºé¡µé¢",
                "- [ ] é›†æˆ API",
                "- [ ] åˆ›å»º PR",
                "",
                "_å®æ—¶æ›´æ–°ä¸­..._"
              ].join("\n")
            });

            core.setOutput("comment_id", comment.id);

      # ========== æ­¥éª¤ 3ï¼šæ‰§è¡Œ Claude Code Action ==========
      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: https://openrouter.ai/api
        with:
          anthropic_api_key: ${{ secrets.OPENROUTER_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: true
          prompt: ${{ steps.prepare.outputs.prompt_content }}
          claude_args: |
            --model anthropic/claude-sonnet-4.5
            --max-turns 25

      # ========== æ­¥éª¤ 4ï¼šæ›´æ–°è¿›åº¦ ==========
      - name: Update Progress
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            let hasChanges = false;
            try {
              const status = execSync('git status --porcelain', { encoding: 'utf8' });
              hasChanges = status.trim().length > 0;
            } catch (e) {}

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.progress.outputs.comment_id }},
              body: [
                "ğŸ¨ **Frontend Agent å·¥ä½œä¸­**",
                "",
                `ğŸ“‹ UI Spec: ${{ steps.prepare.outputs.spec_urls }}`,
                `ğŸŒ¿ åˆ†æ”¯: \`${{ steps.prepare.outputs.branch_name }}\``,
                "",
                "**è¿›åº¦:**",
                "- [x] è§£æ UI Spec",
                hasChanges ? "- [x] ç”Ÿæˆä»£ç " : "- [ ] ç”Ÿæˆä»£ç ï¼ˆæ— å˜æ›´ï¼‰",
                "- [ ] åˆ›å»º PR",
                "",
                hasChanges ? "_æ­£åœ¨åˆ›å»º PR..._" : "_æ— ä»£ç å˜æ›´_"
              ].join("\n")
            });

      # ========== æ­¥éª¤ 5ï¼šåˆ›å»º PR ==========
      - name: Create Pull Request
        if: success()
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ steps.prepare.outputs.branch_name }}
          SPEC_URLS: ${{ steps.prepare.outputs.spec_urls }}
        with:
          script: |
            const { execSync } = require('child_process');

            // æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
            let hasChanges = false;
            try {
              const status = execSync('git status --porcelain', { encoding: 'utf8' });
              hasChanges = status.trim().length > 0;
            } catch (e) {}

            if (!hasChanges) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: ${{ steps.progress.outputs.comment_id }},
                body: [
                  "âš ï¸ **Frontend Agent å®Œæˆï¼ˆæ— å˜æ›´ï¼‰**",
                  "",
                  "æœªæ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œå¯èƒ½çš„åŸå› ï¼š",
                  "- åŠŸèƒ½å·²ç»å®ç°",
                  "- UI Spec ä¸å¤Ÿæ˜ç¡®",
                  "- éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯",
                  "",
                  `ğŸ“‹ UI Spec: ${process.env.SPEC_URLS}`
                ].join("\n")
              });
              return;
            }

            // æäº¤å¹¶æ¨é€
            try {
              execSync('git add .');
              execSync(`git commit -m "feat: frontend implementation for issue #${context.issue.number}"`);
              execSync(`git push origin ${process.env.BRANCH_NAME}`);
            } catch (e) {
              console.log("Commit/push error:", e.message);
            }

            // åˆ›å»º PR
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Frontend: ${context.payload.issue.title} (#${context.issue.number})`,
                head: process.env.BRANCH_NAME,
                base: "main",
                body: [
                  "ğŸ¨ **Frontend Agent è‡ªåŠ¨ç”Ÿæˆ**",
                  "",
                  `ğŸ“‹ UI Spec: ${process.env.SPEC_URLS}`,
                  "",
                  "### å®ç°å†…å®¹",
                  "- é¡µé¢å’Œç»„ä»¶å®ç°",
                  "- API é›†æˆ",
                  "- å“åº”å¼è®¾è®¡",
                  "- Base.org è®¾è®¡ç³»ç»Ÿ",
                  "",
                  "### æŠ€æœ¯æ ˆ",
                  "- Next.js 15 (App Router)",
                  "- React 19",
                  "- TypeScript",
                  "- Tailwind CSS",
                  "- shadcn/ui",
                  "",
                  "### éƒ¨ç½²",
                  "åˆå¹¶åå°†è‡ªåŠ¨éƒ¨ç½²åˆ° Vercel",
                  "",
                  "---",
                  `Related to #${context.issue.number}`,
                  "",
                  "âš ï¸ **æ³¨æ„**: æ­¤ PR ä¸ä¼šè‡ªåŠ¨å…³é—­ issueï¼Œè¯·åœ¨å‰åç«¯éƒ½å®Œæˆå¹¶æµ‹è¯•é€šè¿‡åæ‰‹åŠ¨å…³é—­",
                  "",
                  "ğŸ¤– Generated with Claude Code"
                ].join("\n")
              });

              core.setOutput("pr_url", pr.data.html_url);

              // æœ€ç»ˆæ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: ${{ steps.progress.outputs.comment_id }},
                body: [
                  "âœ… **Frontend Agent å®Œæˆ**",
                  "",
                  `ğŸ“‹ UI Spec: ${process.env.SPEC_URLS}`,
                  `ğŸŒ¿ åˆ†æ”¯: \`${process.env.BRANCH_NAME}\``,
                  `ğŸ”— PR: ${pr.data.html_url}`,
                  "",
                  "**ç»“æœ:**",
                  "- [x] è§£æ UI Spec",
                  "- [x] ç”Ÿæˆä»£ç ",
                  "- [x] åˆ›å»º PR",
                  "",
                  "ğŸ‰ **è¯· review PRï¼**",
                  "",
                  "åˆå¹¶åå°†è‡ªåŠ¨éƒ¨ç½²åˆ° Vercel â–²"
                ].join("\n")
              });

              // æ›´æ–°æ ‡ç­¾
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'ğŸ¤– ai-processing'
              }).catch(() => {});

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['âœ… ai-completed']
              });

            } catch (e) {
              console.error("PR creation failed:", e);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ **PR åˆ›å»ºå¤±è´¥**\n\né”™è¯¯: ${e.message}\n\nåˆ†æ”¯å·²æ¨é€: \`${process.env.BRANCH_NAME}\``
              });
            }

      # ========== å¤±è´¥å¤„ç† ==========
      - name: Handle Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.progress.outputs.comment_id }},
              body: [
                "âŒ **Frontend Agent å¤±è´¥**",
                "",
                `ğŸ“‹ UI Spec: ${{ steps.prepare.outputs.spec_urls }}`,
                "",
                "è¯·æŸ¥çœ‹ [Actions æ—¥å¿—](/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚",
                "",
                "å¯èƒ½çš„åŸå› :",
                "- UI Spec ä¸å¤Ÿæ˜ç¡®",
                "- ä»£ç ç”Ÿæˆé”™è¯¯",
                "- ä¾èµ–é—®é¢˜",
                "",
                "å»ºè®®: æä¾›æ›´è¯¦ç»†çš„ UI Spec æˆ–ç»„ä»¶éœ€æ±‚ã€‚"
              ].join("\n")
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'ğŸ¤– ai-processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['âŒ ai-failed']
            });
