name: Issue Manager

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  manage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Auto-label New Issues
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title || '';
            const text = (title + ' ' + body).toLowerCase();
            
            const labels = [];
            
            // è‡ªåŠ¨è¯†åˆ«ç±»å‹
            if (text.includes('ui') || text.includes('å‰ç«¯') || text.includes('ç•Œé¢')) {
              labels.push('frontend');
            }
            if (text.includes('api') || text.includes('åç«¯') || text.includes('backend')) {
              labels.push('backend');
            }
            if (text.includes('bug') || text.includes('é”™è¯¯')) {
              labels.push('bug');
            }
            if (text.includes('feature') || text.includes('åŠŸèƒ½')) {
              labels.push('enhancement');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels
              });
            }
            
            // æ¬¢è¿æ¶ˆæ¯
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                "ğŸ‘‹ æ¬¢è¿ï¼",
                "",
                labels.length > 0 ? `ğŸ·ï¸ è‡ªåŠ¨æ ‡ç­¾: ${labels.map(l => `\`${l}\``).join(', ')}` : "",
                "",
                "**å¯ç”¨çš„ AI å‘½ä»¤:**",
                "",
                "| å‘½ä»¤ | è¯´æ˜ |",
                "|------|------|",
                "| `/agent-ui` | ç”Ÿæˆ UI è®¾è®¡è§„æ ¼ |",
                "| `/agent-be <url>` | ç”Ÿæˆåç«¯ä»£ç  |",
                "| `/agent-fe <url>` | ç”Ÿæˆå‰ç«¯ä»£ç  |",
                "",
                "**å¼ºåˆ¶åˆ›å»ºæ–° Issueï¼ˆé¿å…è¯„è®ºæŠ˜å ï¼‰:**",
                "",
                "| å‘½ä»¤ | è¯´æ˜ |",
                "|------|------|",
                "| `/agent-new-ui` | åˆ›å»ºå­ Issue å¹¶ç”Ÿæˆ UI è§„æ ¼ |",
                "| `/agent-new-be <url>` | åˆ›å»ºå­ Issue å¹¶ç”Ÿæˆåç«¯ä»£ç  |",
                "| `/agent-new-fe <url>` | åˆ›å»ºå­ Issue å¹¶ç”Ÿæˆå‰ç«¯ä»£ç  |",
                "",
                "> ğŸ’¡ å½“è¯„è®ºè¶…è¿‡ 8 æ¡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºå­ Issue ä»¥ä¿æŒæ¸…æ™°åº¦ã€‚"
              ].join("\n")
            });

      - name: Clean Stale Processing
        if: github.event.action == 'created' && contains(github.event.comment.body, '/clean-stale')
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'ğŸ¤– ai-processing',
              state: 'open'
            });
            
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            let cleaned = 0;
            
            for (const issue of issues) {
              if (new Date(issue.updated_at) < oneDayAgo) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'ğŸ¤– ai-processing'
                }).catch(() => {});
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: "âš ï¸ **å¤„ç†è¶…æ—¶** - å·²ç§»é™¤ processing æ ‡ç­¾ã€‚å¦‚éœ€é‡è¯•ï¼Œè¯·é‡æ–°è§¦å‘å‘½ä»¤ã€‚"
                });
                
                cleaned++;
              }
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… æ¸…ç†å®Œæˆï¼Œå…±å¤„ç† ${cleaned} ä¸ªè¶…æ—¶ issueã€‚`
            });
