name: Vibe AI Engine (Zero Dependency)

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-orchestrator:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: "Vibe Flow: Run AI"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          EVENT_CONTEXT: ${{ github.event_name }}
        uses: actions/github-script@v7
        with:
          script: |
            // 1. ä½¿ç”¨åŸç”Ÿ fetchï¼Œæ— éœ€å®‰è£… axiosï¼Œç›´æ¥è°ƒç”¨
            async function askAI(prompt) {
              const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json',
                  'HTTP-Referer': 'https://github.com/vibe-kanban'
                },
                body: JSON.stringify({
                  model: "anthropic/claude-3.5-sonnet", // æ¨èç”¨äºæ¶æ„è®¾è®¡
                  messages: [{ role: "user", content: prompt }]
                })
              });

              if (!response.ok) {
                const error = await response.text();
                throw new Error(`OpenRouter API Error: ${error}`);
              }

              const data = await response.json();
              return data.choices[0].message.content;
            }

            // 2. é€»è¾‘æ‰§è¡Œ
            if (process.env.EVENT_CONTEXT === 'issues') {
              const prompt = `ä½ æ˜¯ä¸€ä¸ªå…¨æ ˆä¸“å®¶ã€‚é’ˆå¯¹ä»¥ä¸‹éœ€æ±‚ï¼Œä¸º Go + Next.js å›¢é˜Ÿåˆ¶å®šæŠ€æœ¯æ–¹æ¡ˆï¼š
              æ ‡é¢˜: ${process.env.ISSUE_TITLE}
              æè¿°: ${process.env.ISSUE_BODY}
              è¯·ç»™å‡ºï¼šGo å…³é”® Struct å®šä¹‰ã€API å®šä¹‰ã€Next.js ç»„ä»¶å»ºè®®ã€‚
              è¯·éµå¾ª Vibe Kanban çš„ç®€æ´é£æ ¼ã€‚`;
              
              console.log("Sending request to OpenRouter...");
              const aiResponse = await askAI(prompt);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "ğŸ¤– **Vibe AI æ¶æ„å»ºè®®:**\n\n" + aiResponse
              });
              console.log("Comment created successfully.");
            }
