name: Vibe AI Engine

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize]

jobs:
  vibe-assistant:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install axios @actions/github

      - name: "AI: Process Issue (Spec Generation)"
        if: github.event_name == 'issues'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        uses: actions/github-script@v7
        with:
          script: |
            const { callOpenRouter } = require('./.github/scripts/vibe_ai.js');
            const prompt = `ä½ æ˜¯ä¸€ä¸ªå…¨æ ˆä¸“å®¶ã€‚åŸºäºä»¥ä¸‹éœ€æ±‚ï¼Œè¯·ä¸º Go åç«¯å’Œ Next.js å‰ç«¯ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆï¼š
            æ ‡é¢˜: ${process.env.ISSUE_TITLE}
            æè¿°: ${process.env.ISSUE_BODY}
            
            è¦æ±‚æä¾›ï¼š
            1. Go çš„å…³é”® Struct å®šä¹‰ã€‚
            2. Next.js çš„é¡µé¢é€»è¾‘å»ºè®®ã€‚
            3. API å¥‘çº¦ï¼ˆJSON æ ¼å¼è¯´æ˜ï¼‰ã€‚`;
            
            const aiResponse = await callOpenRouter(prompt);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ğŸ¤– **Vibe AI æ¶æ„å»ºè®®:**\n\n" + aiResponse
            });

      - name: "AI: Code Review (Night Watch)"
        if: github.event_name == 'pull_request'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        uses: actions/github-script@v7
        with:
          script: |
            const { callOpenRouter } = require('./.github/scripts/vibe_ai.js');
            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              mediaType: { format: 'diff' }
            });
            
            const prompt = `è¯·å¯¹ä»¥ä¸‹ä»£ç æ”¹åŠ¨è¿›è¡Œ Reviewã€‚
            æŠ€æœ¯æ ˆ: Go, Next.js, Tailwind CSSã€‚
            é‡ç‚¹æ£€æŸ¥ï¼šGo çš„é”™è¯¯å¤„ç†ã€TypeScript ç±»å‹å®‰å…¨ã€Vibe Kanban çš„ç®€æ´é£æ ¼ã€‚
            Diff å†…å®¹: \n${diff.substring(0, 5000)}`; // æˆªå–é˜²æ­¢è¿‡é•¿
            
            const aiResponse = await callOpenRouter(prompt);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ğŸ¤– **Vibe AI ä»£ç è¯„å®¡:**\n\n" + aiResponse
            });
