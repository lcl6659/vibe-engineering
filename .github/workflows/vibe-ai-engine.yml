name: AI Tech Architect (shadcn + Go DB)

on:
  issues:
    types: [labeled]

jobs:
  tech-arch:
    # åªæœ‰æ‰“ä¸Š ğŸ›  tech æ ‡ç­¾æ—¶æ‰è¿è¡Œï¼Œé¿å…ä¸ PM æœºå™¨äººå†²çª
    if: github.event.label.name == 'ğŸ›  tech'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: "Deep Tech Analysis"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = `ä½ æ˜¯ä¸€ä¸ªOpenAIæŠ€æœ¯ Leadã€‚è¯·åˆ†æä»¥ä¸‹éœ€æ±‚å¹¶è¿›è¡Œä»»åŠ¡åˆ†å‘ã€‚
            æ ‡é¢˜: ${process.env.ISSUE_TITLE}
            æè¿°: ${process.env.ISSUE_BODY || "ï¼ˆæ— æè¿°ï¼‰"}

            ### åˆ¤å®šé€»è¾‘ï¼š
            1. å¤æ‚éœ€æ±‚ (is_complex: true)ï¼šæ¶‰åŠå‰åç«¯è”è°ƒã€æ•°æ®åº“å˜åŠ¨ã€æˆ–å¼€å‘å‘¨æœŸ > 2å¤©ã€‚
            2. ç®€å•éœ€æ±‚ (is_complex: false)ï¼šçº¯ UI è°ƒæ•´ã€ç°æœ‰æ¥å£å°ä¿®æ”¹ã€å•ä¸€ Bugfixã€‚

            ### è¾“å‡ºè¦æ±‚ï¼š
            è¯·ç›´æ¥è¾“å‡º JSONï¼Œä¸¥ç¦ä½¿ç”¨ \`\`\`json ç­‰ Markdown æ ‡ç­¾ã€‚
            {
              "is_complex": boolean,
              "estimated_days": "ä¾‹å¦‚ 2-3 å¤©",
              "analysis": "Markdown æ ¼å¼çš„æ€è·¯åˆ†æ",
              "contract": { 
                "be": "Go ä»£ç å—ï¼ˆä¸å«æ ‡ç­¾ï¼‰", 
                "fe": "Markdown æ ¼å¼çš„å‰ç«¯å»ºè®®" 
              },
              "tasks": [ { "role": "BE"|"FE", "title": "æ ‡é¢˜", "body": "è¯¦ç»†æŒ‡ä»¤" } ]
            }`;

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-sonnet-4.5", 
                messages: [{ role: "user", content: prompt }]
              })
            });

            const data = await response.json();
            let rawContent = data.choices[0].message.content.trim();

            // æ¸…æ´— Markdown å¤–å£³
            rawContent = rawContent.replace(/^```json\s*|```$/g, "").trim();

            let result;
            try {
              result = JSON.parse(rawContent);
            } catch (e) {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number,
                body: "âŒ JSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ AI è¿”å›å†…å®¹ã€‚"
              });
              return;
            }

            if (result.is_complex) {
              // 1. åˆ›å»ºå­ Issue å¹¶è®°å½•ç¼–å·
              let taskListMarkdown = "";
              for (const task of result.tasks) {
                const sub = await github.rest.issues.create({
                  owner: context.repo.owner, repo: context.repo.repo,
                  title: `[${task.role}] ${task.title}`,
                  body: `## ğŸ”— å…³è”çˆ¶éœ€æ±‚: #${process.env.ISSUE_NUMBER}\n\n${task.body}`,
                  labels: [task.role === 'FE' ? 'frontend' : 'backend', 'sub-task']
                });
                taskListMarkdown += `- [ ] #${sub.data.number} ${task.title}\n`;
              }

              // 2. æ„é€ å¯è§†åŒ–å·¥ä½œæµ (Mermaid)
              const mermaid = "\`\`\`mermaid\ngraph TD\n  Start[å¼€å§‹] --> BE[åç«¯å¼€å‘]\n  Start --> FE[å‰ç«¯å¼€å‘]\n  BE --> Sync[è”è°ƒæµ‹è¯•]\n  FE --> Sync\n  Sync --> Done[å®Œæˆäº¤ä»˜]\n\`\`\`";

              // 3. æ‹¼æ¥æœ€ç»ˆ Markdown è¯„è®º
              const body = `## ğŸ— [Complex] æŠ€æœ¯æ¶æ„è®¾è®¡\n\n> **é¢„è®¡å·¥æ—¶**: ${result.estimated_days}\n\n### ğŸ’¡ åˆ†ææ€è·¯\n${result.analysis}\n\n### ğŸ’¾ Backend Contract (Go)\n\`\`\`go\n${result.contract.be}\n\`\`\`\n\n### ğŸ¨ Frontend Contract\n${result.contract.fe}\n\n### ğŸ“Š å·¥ä½œæµçœ‹æ¿\n${mermaid}\n\n---\n### ğŸ“‹ ä»»åŠ¡åˆ†è§£è¿›åº¦\n${taskListMarkdown}`;

              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: body
              });
            } else {
              // ç®€å•éœ€æ±‚ç›´æ¥å›å¤
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number,
                body: `## âš¡ [Simple] å®ç°å»ºè®®\n\n${result.analysis}\n\n### ğŸ“ æ–¹æ¡ˆè¯¦æƒ…\n**åç«¯å»ºè®®:**\n${result.contract.be}\n\n**å‰ç«¯å»ºè®®:**\n${result.contract.fe}`
              });
            }
