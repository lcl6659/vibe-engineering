name: AI Tech Architect (shadcn + Go DB)

on:
  issues:
    types: [labeled]

jobs:
  tech-arch:
   # ç¡®ä¿åªæœ‰åŒ…å« 'ğŸ›  tech' çš„æ ‡ç­¾è¢«æ·»åŠ æ—¶ï¼Œæ­¤ Job æ‰çœŸæ­£è¿è¡Œ
    if: |
      github.event.label.name == 'ğŸ›  tech' || 
      (github.event.action == 'labeled' && github.event.label.name == 'ğŸ›  tech')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: "Generate PRD & Tasks"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = `ä½ æ˜¯chatgptï¼ŒopenAIçš„æŠ€æœ¯æœ€é«˜å†³ç­–è€…ã€‚è¯·åˆ†æä»¥ä¸‹éœ€æ±‚å¹¶è¿›è¡Œä»»åŠ¡åˆ†å‘ã€‚

            æ ‡é¢˜: ${process.env.ISSUE_TITLE}
            æè¿°: ${process.env.ISSUE_BODY || "ï¼ˆæ— æè¿°ï¼‰"}

            ### åˆ¤å®šé€»è¾‘ï¼š
            1. å¤æ‚éœ€æ±‚ (is_complex: true)ï¼šæ¶‰åŠå‰åç«¯è”è°ƒã€æ•°æ®åº“æ–°å¢å­—æ®µã€æˆ–å¼€å‘å‘¨æœŸé¢„è®¡ > 2å¤©ã€‚
            2. ç®€å•éœ€æ±‚ (is_complex: false)ï¼šçº¯ UI è°ƒæ•´ã€ç°æœ‰æ¥å£çš„å°é€»è¾‘ä¿®æ”¹ã€å•ä¸€æ–‡ä»¶çš„ Bugfixã€‚

            è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹ JSON è¾“å‡ºï¼ˆä¸è¦åŒ…å«æ–‡å­—è§£é‡Šï¼‰ï¼š
            {
              "is_complex": boolean,
              "analysis": "ç®€çŸ­çš„æ¶æ„/é€»è¾‘æ€è·¯",
              "contract": {
                "be": "Go æ ¸å¿ƒä»£ç /æ¥å£å˜åŠ¨å»ºè®® (å¦‚æœæ˜¯ç®€å•éœ€æ±‚ï¼Œè¯·ç›´æ¥ç»™ä»£ç )",
                "fe": "Next.js æ ¸å¿ƒç»„ä»¶/é€»è¾‘å˜åŠ¨å»ºè®® (å¦‚æœæ˜¯ç®€å•éœ€æ±‚ï¼Œè¯·ç›´æ¥ç»™ä»£ç )"
              },
              "tasks": [ 
                { "role": "BE"|"FE", "title": "ä»»åŠ¡æ ‡é¢˜", "body": "è¯¦ç»†æŒ‡ä»¤" } 
              ] // å¦‚æœ is_complex ä¸º falseï¼Œæ­¤æ•°ç»„ä¸ºç©º
            }`;
            
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: "anthropic/claude-sonnet-4.5", 
                messages: [{ role: "user", content: prompt }]
              })
            });

            const data = await response.json();
            let rawContent = data.choices[0].message.content.trim();

            // --- æ ¸å¿ƒä¿®å¤ï¼šæ¸…æ´— Markdown æ ‡ç­¾ ---
            if (rawContent.includes("```")) {
              rawContent = rawContent.replace(/```json/g, "").replace(/```/g, "").trim();
            }

            let result;
            try {
              result = JSON.parse(rawContent);
            } catch (e) {
              console.error("åŸå§‹è¿”å›å†…å®¹:", rawContent);
              // å¦‚æœè§£æå¤±è´¥ï¼Œåœ¨è¯„è®ºåŒºåé¦ˆæŠ¥é”™ï¼Œæ–¹ä¾¿è°ƒè¯•
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "âŒ AI è¿”å›æ ¼å¼å¼‚å¸¸ï¼Œæ— æ³•è§£æ JSONã€‚è¯·æ£€æŸ¥ API è¿”å›å†…å®¹ã€‚"
              });
              return;
            }

            // --- åç»­ Issue å¤„ç†é€»è¾‘ ---
            if (result.is_complex) {
              let taskListMarkdown = "\n### ğŸ“‹ ä»»åŠ¡åˆ†è§£è¿›åº¦ (Tasks)\n";
              for (const task of result.tasks) {
                const subIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[${task.role}] ${task.title}`,
                  body: `## ğŸ”— å…³è” Epic: #${context.issue.number}\n\n${task.body}`,
                  labels: [task.role === 'FE' ? 'frontend' : 'backend', 'sub-task']
                });
                taskListMarkdown += `- [ ] #${subIssue.data.number} ${task.title}\n`;
              }
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ğŸ— [Complex] æŠ€æœ¯æ¶æ„è®¾è®¡\n${result.analysis}\n\n### ğŸ’¾ Backend Contract (Go)\n\`\`\`go\n${result.contract.be}\n\`\`\`\n### ğŸ¨ Frontend Contract\n${result.contract.fe}\n\n---\n${taskListMarkdown}`
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## âš¡ [Simple] å®ç°å»ºè®®\n${result.analysis}\n\n### ğŸ“ ä»£ç æ–¹æ¡ˆ\n**åç«¯ï¼š**\n${result.contract.be}\n\n**å‰ç«¯ï¼š**\n${result.contract.fe}`
              });
            }
