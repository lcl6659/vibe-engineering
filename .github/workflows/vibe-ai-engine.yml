name: AI Tech Architect (High Performance)

on:
  issues:
    types: [labeled]

jobs:
  tech-arch:
    if: github.event.label.name == 'ğŸ›  tech'
    runs-on: ubuntu-latest
    # å¢åŠ è¶…æ—¶é™åˆ¶ï¼Œé˜²æ­¢å¡æ­»
    timeout-minutes: 5 
    permissions:
      issues: write
    
    steps:
      - name: "Fast Architecture Analysis"
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        uses: actions/github-script@v7
        with:
          script: |
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå…¨æ ˆæ¶æ„å¸ˆã€‚è¾“å‡ºå¿…é¡»ä¸ºä¸¥æ ¼çš„ JSONã€‚
            {
              "analysis": "Markdownæ ¼å¼ï¼šå«æ¶æ„å›¾ã€Go/Next.jsé€‰å‹å–èˆã€å®‰å…¨é£é™©(8æ¡)ã€è¿ç»´ã€5ä¸ªè¿½é—®",
              "frontend": { "title": "å‰ç«¯: ${process.env.ISSUE_TITLE}", "body": "Next.jsç»„ä»¶ã€çŠ¶æ€ç®¡ç†ã€Zodé€»è¾‘" },
              "backend": { "title": "åç«¯: ${process.env.ISSUE_TITLE}", "body": "Go Structã€APIå®šä¹‰ã€GORMã€å¹‚ç­‰è®¾è®¡" }
            }`;

            const userPrompt = `æ ‡é¢˜: ${process.env.ISSUE_TITLE}\næè¿°: ${process.env.ISSUE_BODY}`;

            console.log("æ­£åœ¨è¯·æ±‚ AI æ¨¡å‹...");
            
            try {
              // ä½¿ç”¨ AbortController è®¾ç½® Fetch è¶…æ—¶ (2åˆ†é’Ÿ)
              const controller = new AbortController();
              const timeout = setTimeout(() => controller.abort(), 120000);

              const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                signal: controller.signal,
                body: JSON.stringify({
                  model: "anthropic/claude-sonnet-4.5", 
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ],
                  response_format: { type: "json_object" },
                  temperature: 0.3 // é™ä½éšæœºæ€§ï¼Œæé«˜é€»è¾‘ç¨³å®šæ€§
                })
              });

              clearTimeout(timeout);
              const data = await response.json();
              
              if (!data.choices || data.choices.length === 0) {
                throw new Error("AI è¿”å›æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ API Key æˆ–é¢åº¦");
              }

              const result = JSON.parse(data.choices[0].message.content);
              console.log("AI å“åº”è§£ææˆåŠŸï¼Œæ­£åœ¨åˆ›å»º Issues...");

              // 1. å›å¤ä¸» Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: "## ğŸ›  æ¶æ„æ·±åº¦è§£æ\n\n" + result.analysis
              });

              // 2. æ‰¹é‡åˆ›å»ºå­ä»»åŠ¡ (å¹¶è¡Œæ‰§è¡Œï¼ŒèŠ‚çœæ—¶é—´)
              const tasks = [
                { data: result.frontend, label: 'frontend' },
                { data: result.backend, label: 'backend' }
              ];

              for (const task of tasks) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: task.data.title,
                  body: task.data.body + `\n\n---\nRef: #${context.issue.number}`,
                  labels: [task.label, 'sub-task']
                });
              }

              console.log("æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆã€‚");

            } catch (error) {
              let msg = error.name === 'AbortError' ? "è¯·æ±‚è¶…æ—¶(2min)" : error.message;
              console.error("Error Details:", error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ **è‡ªåŠ¨æ‹†è§£å¤±è´¥**: ${msg}`
              });
            }
